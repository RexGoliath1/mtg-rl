<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">

    <!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>src.mechanics.card_parser - ForgeRL</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">ForgeRL</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <span class="sidebar-brand-text">ForgeRL</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">ForgeRL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ARCHITECTURE.html">ForgeRL Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Local Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/mechanics.html">Mechanics System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/forge.html">Forge Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/agents.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/utils.html">Utils</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for src.mechanics.card_parser</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Card Text Parser</span>

<span class="sd">Parses Scryfall oracle text into mechanics sequences.</span>

<span class="sd">Strategy:</span>
<span class="sd">1. Rule-based parsing for common patterns (handles ~80% of cards)</span>
<span class="sd">2. LLM fallback for complex/ambiguous text (handles remaining ~20%)</span>

<span class="sd">This is NOT meant to be exhaustive from day 1. We iterate:</span>
<span class="sd">- Start with common patterns</span>
<span class="sd">- Add rules as we encounter new patterns</span>
<span class="sd">- LLM handles edge cases during development</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="c1"># Import our vocabulary</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">src.mechanics.vocabulary</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mechanic</span><span class="p">,</span> <span class="n">CardEncoding</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">vocabulary</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mechanic</span><span class="p">,</span> <span class="n">CardEncoding</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># KEYWORD PATTERNS</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># Keywords that appear as single words</span>
<span class="n">KEYWORD_ABILITIES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Evergreen</span>
    <span class="s2">&quot;flying&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FLYING</span><span class="p">,</span>
    <span class="s2">&quot;trample&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TRAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;first strike&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FIRST_STRIKE</span><span class="p">,</span>
    <span class="s2">&quot;double strike&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DOUBLE_STRIKE</span><span class="p">,</span>
    <span class="s2">&quot;deathtouch&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATHTOUCH</span><span class="p">,</span>
    <span class="s2">&quot;lifelink&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LIFELINK</span><span class="p">,</span>
    <span class="s2">&quot;vigilance&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">VIGILANCE</span><span class="p">,</span>
    <span class="s2">&quot;reach&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REACH</span><span class="p">,</span>
    <span class="s2">&quot;haste&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">HASTE</span><span class="p">,</span>
    <span class="s2">&quot;menace&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MENACE</span><span class="p">,</span>
    <span class="s2">&quot;defender&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DEFENDER</span><span class="p">,</span>
    <span class="s2">&quot;indestructible&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">INDESTRUCTIBLE</span><span class="p">,</span>
    <span class="s2">&quot;hexproof&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">HEXPROOF</span><span class="p">,</span>
    <span class="s2">&quot;flash&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FLASH</span><span class="p">,</span>

    <span class="c1"># Combat keywords</span>
    <span class="s2">&quot;skulk&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SKULK</span><span class="p">,</span>
    <span class="s2">&quot;fear&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FEAR</span><span class="p">,</span>
    <span class="s2">&quot;intimidate&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">INTIMIDATE</span><span class="p">,</span>
    <span class="s2">&quot;shadow&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SHADOW</span><span class="p">,</span>
    <span class="s2">&quot;horsemanship&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">HORSEMANSHIP</span><span class="p">,</span>
    <span class="s2">&quot;flanking&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FLANKING</span><span class="p">,</span>
    <span class="s2">&quot;bushido&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BUSHIDO</span><span class="p">,</span>
    <span class="s2">&quot;rampage&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">RAMPAGE</span><span class="p">,</span>
    <span class="s2">&quot;provoke&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PROVOKE</span><span class="p">,</span>
    <span class="s2">&quot;afflict&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">AFFLICT</span><span class="p">,</span>

    <span class="c1"># Counter-related</span>
    <span class="s2">&quot;undying&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">UNDYING</span><span class="p">,</span>
    <span class="s2">&quot;persist&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PERSIST</span><span class="p">,</span>
    <span class="s2">&quot;modular&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MODULAR</span><span class="p">,</span>
    <span class="s2">&quot;evolve&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EVOLVE</span><span class="p">,</span>
    <span class="s2">&quot;graft&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">GRAFT</span><span class="p">,</span>
    <span class="s2">&quot;devour&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DEVOUR</span><span class="p">,</span>
    <span class="s2">&quot;mentor&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MENTOR</span><span class="p">,</span>
    <span class="s2">&quot;training&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">,</span>
    <span class="s2">&quot;renown&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">RENOWN</span><span class="p">,</span>
    <span class="s2">&quot;fabricate&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FABRICATE</span><span class="p">,</span>
    <span class="s2">&quot;backup&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BACKUP</span><span class="p">,</span>
    <span class="s2">&quot;riot&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">RIOT</span><span class="p">,</span>
    <span class="s2">&quot;adapt&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADAPT</span><span class="p">,</span>

    <span class="c1"># Cost reduction</span>
    <span class="s2">&quot;convoke&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CONVOKE</span><span class="p">,</span>
    <span class="s2">&quot;delve&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DELVE</span><span class="p">,</span>
    <span class="s2">&quot;affinity&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">AFFINITY</span><span class="p">,</span>
    <span class="s2">&quot;improvise&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">IMPROVISE</span><span class="p">,</span>
    <span class="s2">&quot;assist&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ASSIST</span><span class="p">,</span>
    <span class="s2">&quot;undaunted&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">UNDAUNTED</span><span class="p">,</span>

    <span class="c1"># Alternative casting</span>
    <span class="s2">&quot;flashback&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FLASHBACK</span><span class="p">,</span>
    <span class="s2">&quot;retrace&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">RETRACE</span><span class="p">,</span>
    <span class="s2">&quot;jump-start&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">JUMP_START</span><span class="p">,</span>
    <span class="s2">&quot;escape&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ESCAPE</span><span class="p">,</span>
    <span class="s2">&quot;foretell&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FORETELL</span><span class="p">,</span>
    <span class="s2">&quot;disturb&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISTURB</span><span class="p">,</span>
    <span class="s2">&quot;warp&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">WARP</span><span class="p">,</span>
    <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DASH</span><span class="p">,</span>
    <span class="s2">&quot;blitz&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BLITZ</span><span class="p">,</span>
    <span class="s2">&quot;evoke&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EVOKE</span><span class="p">,</span>
    <span class="s2">&quot;emerge&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EMERGE</span><span class="p">,</span>
    <span class="s2">&quot;mutate&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MUTATE</span><span class="p">,</span>
    <span class="s2">&quot;spectacle&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SPECTACLE</span><span class="p">,</span>
    <span class="s2">&quot;madness&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MADNESS</span><span class="p">,</span>
    <span class="s2">&quot;ninjutsu&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">NINJUTSU</span><span class="p">,</span>
    <span class="s2">&quot;web-slinging&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">NINJUTSU</span><span class="p">,</span>   <span class="c1"># SPM — alt cost, return tapped creature to hand</span>
    <span class="s2">&quot;sneak&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">NINJUTSU</span><span class="p">,</span>           <span class="c1"># TMT — alt cost, return unblocked attacker to hand</span>
    <span class="s2">&quot;buyback&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BUYBACK</span><span class="p">,</span>
    <span class="s2">&quot;overload&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">OVERLOAD</span><span class="p">,</span>
    <span class="s2">&quot;kicker&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">KICKER</span><span class="p">,</span>
    <span class="s2">&quot;multikicker&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MULTIKICKER</span><span class="p">,</span>

    <span class="c1"># Typecycling variants (land types → TUTOR_LAND, creature types → CREATURE_TYPE_MATTERS)</span>
    <span class="s2">&quot;mountaincycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;forestcycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;islandcycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;plainscycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;swampcycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;basic landcycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;artifact landcycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;wizardcycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>
    <span class="s2">&quot;slivercycling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span>

    <span class="c1"># Triggered keywords</span>
    <span class="s2">&quot;landfall&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LANDFALL</span><span class="p">,</span>
    <span class="s2">&quot;constellation&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CONSTELLATION</span><span class="p">,</span>
    <span class="s2">&quot;heroic&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">HEROIC</span><span class="p">,</span>
    <span class="s2">&quot;magecraft&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MAGECRAFT</span><span class="p">,</span>
    <span class="s2">&quot;prowess&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PROWESS</span><span class="p">,</span>
    <span class="s2">&quot;raid&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">RAID</span><span class="p">,</span>
    <span class="s2">&quot;revolt&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REVOLT</span><span class="p">,</span>
    <span class="s2">&quot;morbid&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MORBID</span><span class="p">,</span>
    <span class="s2">&quot;exploit&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EXPLOIT</span><span class="p">,</span>
    <span class="s2">&quot;extort&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EXTORT</span><span class="p">,</span>
    <span class="s2">&quot;exalted&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EXALTED</span><span class="p">,</span>

    <span class="c1"># Other</span>
    <span class="s2">&quot;changeling&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CHANGELING</span><span class="p">,</span>
    <span class="s2">&quot;devoid&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DEVOID</span><span class="p">,</span>
    <span class="s2">&quot;storm&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">STORM</span><span class="p">,</span>
    <span class="s2">&quot;cascade&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="s2">&quot;dredge&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DREDGE</span><span class="p">,</span>
    <span class="s2">&quot;suspend&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span>
    <span class="s2">&quot;miracle&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MIRACLE</span><span class="p">,</span>
    <span class="s2">&quot;rebound&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REBOUND</span><span class="p">,</span>
    <span class="s2">&quot;cipher&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CIPHER</span><span class="p">,</span>
    <span class="s2">&quot;hideaway&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">HIDEAWAY</span><span class="p">,</span>
    <span class="s2">&quot;living weapon&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LIVING_WEAPON</span><span class="p">,</span>
    <span class="s2">&quot;reconfigure&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">RECONFIGURE</span><span class="p">,</span>
    <span class="s2">&quot;toxic&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TOXIC</span><span class="p">,</span>
    <span class="s2">&quot;infect&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">INFECT</span><span class="p">,</span>
    <span class="s2">&quot;wither&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">WITHER</span><span class="p">,</span>
    <span class="s2">&quot;annihilator&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ANNIHILATOR</span><span class="p">,</span>
    <span class="s2">&quot;myriad&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MYRIAD</span><span class="p">,</span>
    <span class="s2">&quot;encore&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ENCORE</span><span class="p">,</span>
    <span class="s2">&quot;decayed&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DECAYED</span><span class="p">,</span>
    <span class="s2">&quot;prototype&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PROTOTYPE</span><span class="p">,</span>
    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TRANSFORM</span><span class="p">,</span>
    <span class="s2">&quot;daybound&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DAYBOUND</span><span class="p">,</span>
    <span class="s2">&quot;nightbound&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">NIGHTBOUND</span><span class="p">,</span>

    <span class="c1"># Multiplayer</span>
    <span class="s2">&quot;goad&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">GOAD</span><span class="p">,</span>
    <span class="s2">&quot;monarch&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MONARCH</span><span class="p">,</span>
    <span class="s2">&quot;initiative&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">INITIATIVE</span><span class="p">,</span>
    <span class="s2">&quot;populate&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">POPULATE</span><span class="p">,</span>
    <span class="s2">&quot;detain&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DETAIN</span><span class="p">,</span>
    <span class="s2">&quot;eminence&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EMINENCE</span><span class="p">,</span>

    <span class="c1"># Dinosaur/Ixalan</span>
    <span class="s2">&quot;enrage&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DAMAGE_RECEIVED_TRIGGER</span><span class="p">,</span>
    <span class="s2">&quot;explore&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EXPLORE</span><span class="p">,</span>

    <span class="c1"># Conditions</span>
    <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">THRESHOLD</span><span class="p">,</span>
    <span class="s2">&quot;delirium&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DELIRIUM</span><span class="p">,</span>
    <span class="s2">&quot;metalcraft&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">METALCRAFT</span><span class="p">,</span>
    <span class="s2">&quot;ferocious&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FEROCIOUS</span><span class="p">,</span>
    <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DOMAIN</span><span class="p">,</span>
    <span class="s2">&quot;descend&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DESCEND</span><span class="p">,</span>
    <span class="s2">&quot;corrupted&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CORRUPTED</span><span class="p">,</span>
    <span class="s2">&quot;coven&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">COVEN</span><span class="p">,</span>
    <span class="s2">&quot;hellbent&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">HELLBENT</span><span class="p">,</span>
    <span class="s2">&quot;party&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PARTY</span><span class="p">,</span>

    <span class="c1"># Combat keywords (missing)</span>
    <span class="s2">&quot;shroud&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SHROUD</span><span class="p">,</span>
    <span class="s2">&quot;protection&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PROTECTION</span><span class="p">,</span>
    <span class="s2">&quot;ward&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">WARD</span><span class="p">,</span>
    <span class="s2">&quot;banding&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BANDING</span><span class="p">,</span>
    <span class="s2">&quot;absorb&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ABSORB</span><span class="p">,</span>
    <span class="s2">&quot;battle cry&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BATTLE_CRY</span><span class="p">,</span>
    <span class="s2">&quot;melee&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MELEE</span><span class="p">,</span>
    <span class="s2">&quot;split second&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SPLIT_SECOND</span><span class="p">,</span>

    <span class="c1"># Temporal keywords (missing)</span>
    <span class="s2">&quot;phasing&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PHASING</span><span class="p">,</span>
    <span class="s2">&quot;vanishing&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">VANISHING</span><span class="p">,</span>
    <span class="s2">&quot;fading&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FADING</span><span class="p">,</span>
    <span class="s2">&quot;cumulative upkeep&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CUMULATIVE_UPKEEP</span><span class="p">,</span>
    <span class="s2">&quot;echo&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ECHO</span><span class="p">,</span>

    <span class="c1"># Modal/split keywords (missing)</span>
    <span class="s2">&quot;entwine&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ENTWINE</span><span class="p">,</span>
    <span class="s2">&quot;splice&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SPLICE</span><span class="p">,</span>
    <span class="s2">&quot;fuse&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FUSE</span><span class="p">,</span>
    <span class="s2">&quot;aftermath&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">AFTERMATH</span><span class="p">,</span>
    <span class="s2">&quot;adventure&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADVENTURE</span><span class="p">,</span>

    <span class="c1"># Partner/companion (missing)</span>
    <span class="s2">&quot;companion&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">COMPANION</span><span class="p">,</span>
    <span class="s2">&quot;partner with&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PARTNER_WITH</span><span class="p">,</span>
    <span class="s2">&quot;partner&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PARTNER</span><span class="p">,</span>

    <span class="c1"># Aura/equipment keywords (missing)</span>
    <span class="s2">&quot;equip&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EQUIP</span><span class="p">,</span>
    <span class="s2">&quot;bestow&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BESTOW</span><span class="p">,</span>
    <span class="s2">&quot;soulbond&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SOULBOND</span><span class="p">,</span>
    <span class="s2">&quot;regenerate&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REGENERATE</span><span class="p">,</span>

    <span class="c1"># Tribute/choice (missing)</span>
    <span class="s2">&quot;tribute&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TRIBUTE</span><span class="p">,</span>

    <span class="c1"># Recent set mechanics (missing)</span>
    <span class="s2">&quot;cleave&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CLEAVE</span><span class="p">,</span>
    <span class="s2">&quot;casualty&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CASUALTY</span><span class="p">,</span>
    <span class="c1"># &quot;connive&quot; handled via PATTERNS to catch verb conjugations (connives, connived)</span>
    <span class="s2">&quot;for mirrodin!&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FOR_MIRRODIN</span><span class="p">,</span>
    <span class="s2">&quot;incubate&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">INCUBATE</span><span class="p">,</span>
    <span class="s2">&quot;learn&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LEARN</span><span class="p">,</span>
    <span class="s2">&quot;craft&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CRAFT</span><span class="p">,</span>
    <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLOT</span><span class="p">,</span>
    <span class="s2">&quot;morph&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MORPH</span><span class="p">,</span>
    <span class="s2">&quot;manifest&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MANIFEST</span><span class="p">,</span>
    <span class="s2">&quot;disguise&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISGUISE</span><span class="p">,</span>
    <span class="s2">&quot;discover&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCOVER</span><span class="p">,</span>
    <span class="s2">&quot;monstrosity&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MONSTROSITY</span><span class="p">,</span>
    <span class="s2">&quot;support&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SUPPORT</span><span class="p">,</span>
    <span class="s2">&quot;bolster&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BOLSTER</span><span class="p">,</span>
    <span class="s2">&quot;transmute&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TRANSMUTE</span><span class="p">,</span>
    <span class="s2">&quot;forecast&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FORECAST</span><span class="p">,</span>
    <span class="s2">&quot;bloodthirst&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">BLOODTHIRST</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># KEYWORD COST TAXONOMY</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Maps keywords from KEYWORD_ABILITIES to their cost category.</span>
<span class="c1"># When a keyword is detected, we also fire the appropriate cost enum.</span>
<span class="c1"># See docs/MTG_RULES_REFERENCE.md for full rules classification.</span>

<span class="n">KEYWORD_COST_CATEGORY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># --- ADDITIONAL COSTS (Rule 118.8) ---</span>
    <span class="c1"># Paid ON TOP of the mana cost</span>
    <span class="s2">&quot;kicker&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>
    <span class="s2">&quot;multikicker&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>
    <span class="s2">&quot;buyback&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>
    <span class="s2">&quot;entwine&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>
    <span class="s2">&quot;exploit&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>
    <span class="s2">&quot;casualty&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>
    <span class="s2">&quot;splice&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>
    <span class="s2">&quot;retrace&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>       <span class="c1"># Cast from GY + discard land</span>
    <span class="s2">&quot;jump-start&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span>    <span class="c1"># Cast from GY + discard card</span>

    <span class="c1"># --- ALTERNATIVE COSTS (Rule 118.9) ---</span>
    <span class="c1"># Replaces the mana cost entirely</span>
    <span class="s2">&quot;flashback&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;overload&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;madness&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;evoke&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;blitz&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;bestow&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;escape&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;disturb&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;foretell&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;miracle&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;morph&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;disguise&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;spectacle&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;ninjutsu&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;web-slinging&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;sneak&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;cleave&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;emerge&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;mutate&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;warp&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>
    <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">,</span>

    <span class="c1"># --- COST REDUCTION (not additional or alternative per rules) ---</span>
    <span class="s2">&quot;convoke&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REDUCE_COST</span><span class="p">,</span>
    <span class="s2">&quot;delve&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REDUCE_COST</span><span class="p">,</span>
    <span class="s2">&quot;affinity&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REDUCE_COST</span><span class="p">,</span>
    <span class="s2">&quot;improvise&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REDUCE_COST</span><span class="p">,</span>
    <span class="s2">&quot;undaunted&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REDUCE_COST</span><span class="p">,</span>
    <span class="s2">&quot;assist&quot;</span><span class="p">:</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REDUCE_COST</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># KEYWORD IMPLIED EFFECTS</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Maps keywords to mechanical effects hidden in their reminder text.</span>
<span class="c1"># Since strip_reminder_text() removes ALL parenthesized text before parsing,</span>
<span class="c1"># these effects would otherwise be invisible to the parser.</span>
<span class="c1"># Only includes high-value signals — effects the network can learn from.</span>

<span class="n">KEYWORD_IMPLICATIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># --- Additional cost implied effects ---</span>
    <span class="s2">&quot;buyback&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TO_HAND</span><span class="p">],</span>              <span class="c1"># Return spell to hand instead of graveyard</span>
    <span class="s2">&quot;exploit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>             <span class="c1"># May sacrifice a creature on ETB</span>
    <span class="s2">&quot;casualty&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>            <span class="c1"># Sacrifice creature with power N+</span>
    <span class="s2">&quot;retrace&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">],</span>
    <span class="s2">&quot;jump-start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">],</span>

    <span class="c1"># --- Alternative cost implied effects ---</span>
    <span class="s2">&quot;flashback&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">],</span>
    <span class="s2">&quot;escape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">],</span>
    <span class="s2">&quot;disturb&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TRANSFORM</span><span class="p">],</span>
    <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HASTE</span><span class="p">],</span>                    <span class="c1"># Gains haste, returns to hand at end step</span>
    <span class="s2">&quot;blitz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HASTE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">],</span>    <span class="c1"># Haste + draw on death + sacrifice at end step</span>
    <span class="s2">&quot;evoke&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>               <span class="c1"># Sacrifice on ETB when evoked</span>
    <span class="s2">&quot;emerge&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>              <span class="c1"># Sacrifice creature as part of cost</span>
    <span class="s2">&quot;ninjutsu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BOUNCE_TO_HAND</span><span class="p">],</span>       <span class="c1"># Return unblocked attacker to hand</span>
    <span class="s2">&quot;web-slinging&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BOUNCE_TO_HAND</span><span class="p">],</span>   <span class="c1"># Return tapped creature to hand</span>
    <span class="s2">&quot;sneak&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BOUNCE_TO_HAND</span><span class="p">],</span>           <span class="c1"># Return unblocked attacker to hand</span>
    <span class="s2">&quot;foretell&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_EXILE</span><span class="p">],</span>      <span class="c1"># Exile face-down, cast later</span>
    <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_EXILE</span><span class="p">],</span>           <span class="c1"># Exile, cast free on later turn</span>
    <span class="s2">&quot;warp&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_EXILE</span><span class="p">],</span>           <span class="c1"># Exile, recast later</span>
    <span class="s2">&quot;madness&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">],</span>               <span class="c1"># Triggered by being discarded</span>

    <span class="c1"># --- Non-cost keywords with important implied effects ---</span>
    <span class="s2">&quot;undying&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATH_TRIGGER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;persist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATH_TRIGGER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;modular&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATH_TRIGGER</span><span class="p">],</span>
    <span class="s2">&quot;storm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COPY_SPELL</span><span class="p">],</span>
    <span class="s2">&quot;cascade&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FREE_CAST_CONDITION</span><span class="p">],</span>
    <span class="s2">&quot;dredge&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MILL</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REGROWTH</span><span class="p">],</span>
    <span class="s2">&quot;encore&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">],</span>
    <span class="s2">&quot;cycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">],</span>
    <span class="c1"># Typecycling — all share DRAW+DISCARD from cycling, land variants also tutor</span>
    <span class="s2">&quot;mountaincycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">],</span>
    <span class="s2">&quot;forestcycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">],</span>
    <span class="s2">&quot;islandcycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">],</span>
    <span class="s2">&quot;plainscycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">],</span>
    <span class="s2">&quot;swampcycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">],</span>
    <span class="s2">&quot;basic landcycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">],</span>
    <span class="s2">&quot;artifact landcycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">],</span>
    <span class="s2">&quot;wizardcycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATURE_TYPE_MATTERS</span><span class="p">],</span>
    <span class="s2">&quot;slivercycling&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATURE_TYPE_MATTERS</span><span class="p">],</span>
    <span class="s2">&quot;morph&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">],</span>
    <span class="s2">&quot;manifest&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">],</span>
    <span class="s2">&quot;disguise&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">],</span>
    <span class="s2">&quot;infect&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">POISON_COUNTER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;wither&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;living weapon&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EQUIP</span><span class="p">],</span>
    <span class="s2">&quot;devour&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;fabricate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">],</span>
    <span class="s2">&quot;extort&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_LIFE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE</span><span class="p">],</span>
    <span class="s2">&quot;annihilator&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>
    <span class="s2">&quot;mentor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;training&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;evolve&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;riot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HASTE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;adapt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;monstrosity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;renown&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;support&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;bolster&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;backup&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;decayed&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>             <span class="c1"># Sacrifice after attacking</span>
    <span class="s2">&quot;afflict&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE</span><span class="p">],</span>             <span class="c1"># Opponent loses N when this is blocked</span>
    <span class="s2">&quot;battle cry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ANTHEM_EFFECT</span><span class="p">],</span>       <span class="c1"># Attacking creatures get +1/+0</span>
    <span class="s2">&quot;exalted&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_POWER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_TOUGHNESS</span><span class="p">],</span>
    <span class="s2">&quot;prowess&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_POWER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_TOUGHNESS</span><span class="p">],</span>
    <span class="s2">&quot;flanking&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_POWER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_TOUGHNESS</span><span class="p">],</span>
    <span class="s2">&quot;incubate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">],</span>
    <span class="s2">&quot;suspend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_EXILE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">HASTE</span><span class="p">],</span>
    <span class="s2">&quot;discover&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FREE_CAST_CONDITION</span><span class="p">],</span>
    <span class="s2">&quot;learn&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">],</span>  <span class="c1"># Draw a Lesson or loot</span>
    <span class="s2">&quot;transmute&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_TO_HAND</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">],</span>
    <span class="s2">&quot;forecast&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_HAND</span><span class="p">],</span>
    <span class="s2">&quot;converge&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_FIXING</span><span class="p">],</span>
    <span class="s2">&quot;goad&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACKS_EACH_COMBAT</span><span class="p">],</span>
    <span class="s2">&quot;provoke&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MUST_BE_BLOCKED</span><span class="p">],</span>
    <span class="s2">&quot;populate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">],</span>
    <span class="s2">&quot;detain&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_ATTACK</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_BLOCK</span><span class="p">],</span>
    <span class="s2">&quot;partner with&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_TO_HAND</span><span class="p">],</span>
<span class="p">}</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># TOKEN IMPLIED EFFECTS</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Maps token types to their inherent mechanical effects.</span>
<span class="c1"># When a card creates/mentions these tokens, the token&#39;s built-in abilities</span>
<span class="c1"># are added so the network understands what the token actually does.</span>
<span class="c1"># (Token abilities are in reminder text which gets stripped.)</span>

<span class="n">TOKEN_IMPLICATIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;food&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_LIFE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>           <span class="c1"># {2}, {T}, Sacrifice: Gain 3 life</span>
    <span class="s2">&quot;clue&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>                <span class="c1"># {2}, Sacrifice: Draw a card</span>
    <span class="s2">&quot;treasure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>    <span class="c1"># Sacrifice: Add one mana of any color</span>
    <span class="s2">&quot;blood&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>  <span class="c1"># {1}, {T}, Discard, Sacrifice: Draw</span>
    <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXPLORE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>              <span class="c1"># {1}, {T}, Sacrifice: Target creature explores</span>
    <span class="s2">&quot;powerstone&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span><span class="p">],</span>                      <span class="c1"># {T}: Add {C} (can&#39;t cast nonartifact)</span>
    <span class="s2">&quot;incubator&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TRANSFORM</span><span class="p">],</span>   <span class="c1"># {2}: Transform into Phyrexian token</span>
    <span class="s2">&quot;shard&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>       <span class="c1"># {2}, Sacrifice: Add 3 mana of one color</span>
    <span class="s2">&quot;gold&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>        <span class="c1"># Sacrifice: Add one mana of any color</span>
    <span class="s2">&quot;junk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">],</span>                <span class="c1"># {2}, {T}, Sacrifice: Draw (same as Clue)</span>
<span class="p">}</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># CREATURE TYPE DATABASE (from Scryfall catalog API)</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Complete list of all MTG creature types. Used for context-filtered detection</span>
<span class="c1"># of tribal/creature-type-matters cards. All map to CREATURE_TYPE_MATTERS.</span>
<span class="c1"># This is a reference database, NOT individual features in the vocabulary.</span>
<span class="c1"># Source: https://api.scryfall.com/catalog/creature-types (302 types)</span>

<span class="n">ALL_CREATURE_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;advisor&quot;</span><span class="p">,</span> <span class="s2">&quot;aetherborn&quot;</span><span class="p">,</span> <span class="s2">&quot;alien&quot;</span><span class="p">,</span> <span class="s2">&quot;ally&quot;</span><span class="p">,</span> <span class="s2">&quot;angel&quot;</span><span class="p">,</span> <span class="s2">&quot;antelope&quot;</span><span class="p">,</span> <span class="s2">&quot;ape&quot;</span><span class="p">,</span>
    <span class="s2">&quot;archer&quot;</span><span class="p">,</span> <span class="s2">&quot;archon&quot;</span><span class="p">,</span> <span class="s2">&quot;armadillo&quot;</span><span class="p">,</span> <span class="s2">&quot;army&quot;</span><span class="p">,</span> <span class="s2">&quot;artificer&quot;</span><span class="p">,</span> <span class="s2">&quot;assassin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;assembly-worker&quot;</span><span class="p">,</span> <span class="s2">&quot;astartes&quot;</span><span class="p">,</span> <span class="s2">&quot;atog&quot;</span><span class="p">,</span> <span class="s2">&quot;aurochs&quot;</span><span class="p">,</span> <span class="s2">&quot;automaton&quot;</span><span class="p">,</span> <span class="s2">&quot;avatar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;azra&quot;</span><span class="p">,</span> <span class="s2">&quot;badger&quot;</span><span class="p">,</span> <span class="s2">&quot;balloon&quot;</span><span class="p">,</span> <span class="s2">&quot;barbarian&quot;</span><span class="p">,</span> <span class="s2">&quot;bard&quot;</span><span class="p">,</span> <span class="s2">&quot;basilisk&quot;</span><span class="p">,</span> <span class="s2">&quot;bat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bear&quot;</span><span class="p">,</span> <span class="s2">&quot;beast&quot;</span><span class="p">,</span> <span class="s2">&quot;beaver&quot;</span><span class="p">,</span> <span class="s2">&quot;beeble&quot;</span><span class="p">,</span> <span class="s2">&quot;beholder&quot;</span><span class="p">,</span> <span class="s2">&quot;berserker&quot;</span><span class="p">,</span> <span class="s2">&quot;bird&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bison&quot;</span><span class="p">,</span> <span class="s2">&quot;blinkmoth&quot;</span><span class="p">,</span> <span class="s2">&quot;boar&quot;</span><span class="p">,</span> <span class="s2">&quot;brainiac&quot;</span><span class="p">,</span> <span class="s2">&quot;bringer&quot;</span><span class="p">,</span> <span class="s2">&quot;brushwagg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;c&#39;tan&quot;</span><span class="p">,</span> <span class="s2">&quot;camarid&quot;</span><span class="p">,</span> <span class="s2">&quot;camel&quot;</span><span class="p">,</span> <span class="s2">&quot;capybara&quot;</span><span class="p">,</span> <span class="s2">&quot;caribou&quot;</span><span class="p">,</span> <span class="s2">&quot;carrier&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;centaur&quot;</span><span class="p">,</span> <span class="s2">&quot;chicken&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">,</span> <span class="s2">&quot;chimera&quot;</span><span class="p">,</span> <span class="s2">&quot;citizen&quot;</span><span class="p">,</span> <span class="s2">&quot;cleric&quot;</span><span class="p">,</span> <span class="s2">&quot;clown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cockatrice&quot;</span><span class="p">,</span> <span class="s2">&quot;construct&quot;</span><span class="p">,</span> <span class="s2">&quot;coward&quot;</span><span class="p">,</span> <span class="s2">&quot;coyote&quot;</span><span class="p">,</span> <span class="s2">&quot;crab&quot;</span><span class="p">,</span> <span class="s2">&quot;crocodile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;custodes&quot;</span><span class="p">,</span> <span class="s2">&quot;cyberman&quot;</span><span class="p">,</span> <span class="s2">&quot;cyclops&quot;</span><span class="p">,</span> <span class="s2">&quot;dalek&quot;</span><span class="p">,</span> <span class="s2">&quot;dauthi&quot;</span><span class="p">,</span> <span class="s2">&quot;demigod&quot;</span><span class="p">,</span>
    <span class="s2">&quot;demon&quot;</span><span class="p">,</span> <span class="s2">&quot;deserter&quot;</span><span class="p">,</span> <span class="s2">&quot;detective&quot;</span><span class="p">,</span> <span class="s2">&quot;devil&quot;</span><span class="p">,</span> <span class="s2">&quot;dinosaur&quot;</span><span class="p">,</span> <span class="s2">&quot;djinn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doctor&quot;</span><span class="p">,</span> <span class="s2">&quot;dog&quot;</span><span class="p">,</span> <span class="s2">&quot;dragon&quot;</span><span class="p">,</span> <span class="s2">&quot;drake&quot;</span><span class="p">,</span> <span class="s2">&quot;dreadnought&quot;</span><span class="p">,</span> <span class="s2">&quot;drix&quot;</span><span class="p">,</span> <span class="s2">&quot;drone&quot;</span><span class="p">,</span>
    <span class="s2">&quot;druid&quot;</span><span class="p">,</span> <span class="s2">&quot;dryad&quot;</span><span class="p">,</span> <span class="s2">&quot;dwarf&quot;</span><span class="p">,</span> <span class="s2">&quot;echidna&quot;</span><span class="p">,</span> <span class="s2">&quot;efreet&quot;</span><span class="p">,</span> <span class="s2">&quot;egg&quot;</span><span class="p">,</span> <span class="s2">&quot;elder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eldrazi&quot;</span><span class="p">,</span> <span class="s2">&quot;elemental&quot;</span><span class="p">,</span> <span class="s2">&quot;elephant&quot;</span><span class="p">,</span> <span class="s2">&quot;elf&quot;</span><span class="p">,</span> <span class="s2">&quot;elk&quot;</span><span class="p">,</span> <span class="s2">&quot;employee&quot;</span><span class="p">,</span> <span class="s2">&quot;eye&quot;</span><span class="p">,</span>
    <span class="s2">&quot;faerie&quot;</span><span class="p">,</span> <span class="s2">&quot;ferret&quot;</span><span class="p">,</span> <span class="s2">&quot;fish&quot;</span><span class="p">,</span> <span class="s2">&quot;flagbearer&quot;</span><span class="p">,</span> <span class="s2">&quot;fox&quot;</span><span class="p">,</span> <span class="s2">&quot;fractal&quot;</span><span class="p">,</span> <span class="s2">&quot;frog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fungus&quot;</span><span class="p">,</span> <span class="s2">&quot;gamer&quot;</span><span class="p">,</span> <span class="s2">&quot;gargoyle&quot;</span><span class="p">,</span> <span class="s2">&quot;germ&quot;</span><span class="p">,</span> <span class="s2">&quot;giant&quot;</span><span class="p">,</span> <span class="s2">&quot;gith&quot;</span><span class="p">,</span> <span class="s2">&quot;glimmer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gnoll&quot;</span><span class="p">,</span> <span class="s2">&quot;gnome&quot;</span><span class="p">,</span> <span class="s2">&quot;goat&quot;</span><span class="p">,</span> <span class="s2">&quot;goblin&quot;</span><span class="p">,</span> <span class="s2">&quot;god&quot;</span><span class="p">,</span> <span class="s2">&quot;golem&quot;</span><span class="p">,</span> <span class="s2">&quot;gorgon&quot;</span><span class="p">,</span>
    <span class="s2">&quot;graveborn&quot;</span><span class="p">,</span> <span class="s2">&quot;gremlin&quot;</span><span class="p">,</span> <span class="s2">&quot;griffin&quot;</span><span class="p">,</span> <span class="s2">&quot;guest&quot;</span><span class="p">,</span> <span class="s2">&quot;hag&quot;</span><span class="p">,</span> <span class="s2">&quot;halfling&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hamster&quot;</span><span class="p">,</span> <span class="s2">&quot;harpy&quot;</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="s2">&quot;hedgehog&quot;</span><span class="p">,</span> <span class="s2">&quot;hellion&quot;</span><span class="p">,</span> <span class="s2">&quot;hero&quot;</span><span class="p">,</span> <span class="s2">&quot;hippo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hippogriff&quot;</span><span class="p">,</span> <span class="s2">&quot;homarid&quot;</span><span class="p">,</span> <span class="s2">&quot;homunculus&quot;</span><span class="p">,</span> <span class="s2">&quot;horror&quot;</span><span class="p">,</span> <span class="s2">&quot;horse&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hydra&quot;</span><span class="p">,</span> <span class="s2">&quot;hyena&quot;</span><span class="p">,</span> <span class="s2">&quot;illusion&quot;</span><span class="p">,</span> <span class="s2">&quot;imp&quot;</span><span class="p">,</span> <span class="s2">&quot;incarnation&quot;</span><span class="p">,</span> <span class="s2">&quot;inkling&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inquisitor&quot;</span><span class="p">,</span> <span class="s2">&quot;insect&quot;</span><span class="p">,</span> <span class="s2">&quot;jackal&quot;</span><span class="p">,</span> <span class="s2">&quot;jellyfish&quot;</span><span class="p">,</span> <span class="s2">&quot;juggernaut&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kangaroo&quot;</span><span class="p">,</span> <span class="s2">&quot;kavu&quot;</span><span class="p">,</span> <span class="s2">&quot;kirin&quot;</span><span class="p">,</span> <span class="s2">&quot;kithkin&quot;</span><span class="p">,</span> <span class="s2">&quot;knight&quot;</span><span class="p">,</span> <span class="s2">&quot;kobold&quot;</span><span class="p">,</span> <span class="s2">&quot;kor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kraken&quot;</span><span class="p">,</span> <span class="s2">&quot;lamia&quot;</span><span class="p">,</span> <span class="s2">&quot;lammasu&quot;</span><span class="p">,</span> <span class="s2">&quot;leech&quot;</span><span class="p">,</span> <span class="s2">&quot;lemur&quot;</span><span class="p">,</span> <span class="s2">&quot;leviathan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lhurgoyf&quot;</span><span class="p">,</span> <span class="s2">&quot;licid&quot;</span><span class="p">,</span> <span class="s2">&quot;lizard&quot;</span><span class="p">,</span> <span class="s2">&quot;llama&quot;</span><span class="p">,</span> <span class="s2">&quot;lobster&quot;</span><span class="p">,</span> <span class="s2">&quot;manticore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;masticore&quot;</span><span class="p">,</span> <span class="s2">&quot;mercenary&quot;</span><span class="p">,</span> <span class="s2">&quot;merfolk&quot;</span><span class="p">,</span> <span class="s2">&quot;metathran&quot;</span><span class="p">,</span> <span class="s2">&quot;minion&quot;</span><span class="p">,</span> <span class="s2">&quot;minotaur&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mite&quot;</span><span class="p">,</span> <span class="s2">&quot;mole&quot;</span><span class="p">,</span> <span class="s2">&quot;monger&quot;</span><span class="p">,</span> <span class="s2">&quot;mongoose&quot;</span><span class="p">,</span> <span class="s2">&quot;monk&quot;</span><span class="p">,</span> <span class="s2">&quot;monkey&quot;</span><span class="p">,</span> <span class="s2">&quot;moogle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;moonfolk&quot;</span><span class="p">,</span> <span class="s2">&quot;mount&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;mutant&quot;</span><span class="p">,</span> <span class="s2">&quot;myr&quot;</span><span class="p">,</span> <span class="s2">&quot;mystic&quot;</span><span class="p">,</span> <span class="s2">&quot;naga&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nautilus&quot;</span><span class="p">,</span> <span class="s2">&quot;necron&quot;</span><span class="p">,</span> <span class="s2">&quot;nephilim&quot;</span><span class="p">,</span> <span class="s2">&quot;nightmare&quot;</span><span class="p">,</span> <span class="s2">&quot;nightstalker&quot;</span><span class="p">,</span> <span class="s2">&quot;ninja&quot;</span><span class="p">,</span>
    <span class="s2">&quot;noble&quot;</span><span class="p">,</span> <span class="s2">&quot;noggle&quot;</span><span class="p">,</span> <span class="s2">&quot;nomad&quot;</span><span class="p">,</span> <span class="s2">&quot;nymph&quot;</span><span class="p">,</span> <span class="s2">&quot;octopus&quot;</span><span class="p">,</span> <span class="s2">&quot;ogre&quot;</span><span class="p">,</span> <span class="s2">&quot;ooze&quot;</span><span class="p">,</span> <span class="s2">&quot;orb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;orc&quot;</span><span class="p">,</span> <span class="s2">&quot;orgg&quot;</span><span class="p">,</span> <span class="s2">&quot;otter&quot;</span><span class="p">,</span> <span class="s2">&quot;ouphe&quot;</span><span class="p">,</span> <span class="s2">&quot;ox&quot;</span><span class="p">,</span> <span class="s2">&quot;oyster&quot;</span><span class="p">,</span> <span class="s2">&quot;pangolin&quot;</span><span class="p">,</span> <span class="s2">&quot;peasant&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pegasus&quot;</span><span class="p">,</span> <span class="s2">&quot;pentavite&quot;</span><span class="p">,</span> <span class="s2">&quot;performer&quot;</span><span class="p">,</span> <span class="s2">&quot;pest&quot;</span><span class="p">,</span> <span class="s2">&quot;phelddagrif&quot;</span><span class="p">,</span> <span class="s2">&quot;phoenix&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phyrexian&quot;</span><span class="p">,</span> <span class="s2">&quot;pilot&quot;</span><span class="p">,</span> <span class="s2">&quot;pincher&quot;</span><span class="p">,</span> <span class="s2">&quot;pirate&quot;</span><span class="p">,</span> <span class="s2">&quot;plant&quot;</span><span class="p">,</span> <span class="s2">&quot;platypus&quot;</span><span class="p">,</span>
    <span class="s2">&quot;porcupine&quot;</span><span class="p">,</span> <span class="s2">&quot;possum&quot;</span><span class="p">,</span> <span class="s2">&quot;praetor&quot;</span><span class="p">,</span> <span class="s2">&quot;primarch&quot;</span><span class="p">,</span> <span class="s2">&quot;prism&quot;</span><span class="p">,</span> <span class="s2">&quot;processor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qu&quot;</span><span class="p">,</span> <span class="s2">&quot;rabbit&quot;</span><span class="p">,</span> <span class="s2">&quot;raccoon&quot;</span><span class="p">,</span> <span class="s2">&quot;ranger&quot;</span><span class="p">,</span> <span class="s2">&quot;rat&quot;</span><span class="p">,</span> <span class="s2">&quot;rebel&quot;</span><span class="p">,</span> <span class="s2">&quot;reflection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reveler&quot;</span><span class="p">,</span> <span class="s2">&quot;rhino&quot;</span><span class="p">,</span> <span class="s2">&quot;rigger&quot;</span><span class="p">,</span> <span class="s2">&quot;robot&quot;</span><span class="p">,</span> <span class="s2">&quot;rogue&quot;</span><span class="p">,</span> <span class="s2">&quot;rukh&quot;</span><span class="p">,</span> <span class="s2">&quot;sable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;salamander&quot;</span><span class="p">,</span> <span class="s2">&quot;samurai&quot;</span><span class="p">,</span> <span class="s2">&quot;sand&quot;</span><span class="p">,</span> <span class="s2">&quot;saproling&quot;</span><span class="p">,</span> <span class="s2">&quot;satyr&quot;</span><span class="p">,</span> <span class="s2">&quot;scarecrow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scientist&quot;</span><span class="p">,</span> <span class="s2">&quot;scion&quot;</span><span class="p">,</span> <span class="s2">&quot;scorpion&quot;</span><span class="p">,</span> <span class="s2">&quot;scout&quot;</span><span class="p">,</span> <span class="s2">&quot;sculpture&quot;</span><span class="p">,</span> <span class="s2">&quot;seal&quot;</span><span class="p">,</span> <span class="s2">&quot;serf&quot;</span><span class="p">,</span>
    <span class="s2">&quot;serpent&quot;</span><span class="p">,</span> <span class="s2">&quot;servo&quot;</span><span class="p">,</span> <span class="s2">&quot;shade&quot;</span><span class="p">,</span> <span class="s2">&quot;shaman&quot;</span><span class="p">,</span> <span class="s2">&quot;shapeshifter&quot;</span><span class="p">,</span> <span class="s2">&quot;shark&quot;</span><span class="p">,</span> <span class="s2">&quot;sheep&quot;</span><span class="p">,</span>
    <span class="s2">&quot;siren&quot;</span><span class="p">,</span> <span class="s2">&quot;skeleton&quot;</span><span class="p">,</span> <span class="s2">&quot;skrull&quot;</span><span class="p">,</span> <span class="s2">&quot;skunk&quot;</span><span class="p">,</span> <span class="s2">&quot;slith&quot;</span><span class="p">,</span> <span class="s2">&quot;sliver&quot;</span><span class="p">,</span> <span class="s2">&quot;sloth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;slug&quot;</span><span class="p">,</span> <span class="s2">&quot;snail&quot;</span><span class="p">,</span> <span class="s2">&quot;snake&quot;</span><span class="p">,</span> <span class="s2">&quot;soldier&quot;</span><span class="p">,</span> <span class="s2">&quot;soltari&quot;</span><span class="p">,</span> <span class="s2">&quot;sorcerer&quot;</span><span class="p">,</span> <span class="s2">&quot;spawn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;specter&quot;</span><span class="p">,</span> <span class="s2">&quot;spellshaper&quot;</span><span class="p">,</span> <span class="s2">&quot;sphinx&quot;</span><span class="p">,</span> <span class="s2">&quot;spider&quot;</span><span class="p">,</span> <span class="s2">&quot;spike&quot;</span><span class="p">,</span> <span class="s2">&quot;spirit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;splinter&quot;</span><span class="p">,</span> <span class="s2">&quot;sponge&quot;</span><span class="p">,</span> <span class="s2">&quot;spy&quot;</span><span class="p">,</span> <span class="s2">&quot;squid&quot;</span><span class="p">,</span> <span class="s2">&quot;squirrel&quot;</span><span class="p">,</span> <span class="s2">&quot;starfish&quot;</span><span class="p">,</span>
    <span class="s2">&quot;surrakar&quot;</span><span class="p">,</span> <span class="s2">&quot;survivor&quot;</span><span class="p">,</span> <span class="s2">&quot;symbiote&quot;</span><span class="p">,</span> <span class="s2">&quot;synth&quot;</span><span class="p">,</span> <span class="s2">&quot;teddy&quot;</span><span class="p">,</span> <span class="s2">&quot;tentacle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tetravite&quot;</span><span class="p">,</span> <span class="s2">&quot;thalakos&quot;</span><span class="p">,</span> <span class="s2">&quot;thopter&quot;</span><span class="p">,</span> <span class="s2">&quot;thrull&quot;</span><span class="p">,</span> <span class="s2">&quot;tiefling&quot;</span><span class="p">,</span> <span class="s2">&quot;time lord&quot;</span><span class="p">,</span>
    <span class="s2">&quot;toy&quot;</span><span class="p">,</span> <span class="s2">&quot;treefolk&quot;</span><span class="p">,</span> <span class="s2">&quot;trilobite&quot;</span><span class="p">,</span> <span class="s2">&quot;triskelavite&quot;</span><span class="p">,</span> <span class="s2">&quot;troll&quot;</span><span class="p">,</span> <span class="s2">&quot;turtle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tyranid&quot;</span><span class="p">,</span> <span class="s2">&quot;unicorn&quot;</span><span class="p">,</span> <span class="s2">&quot;urzan&quot;</span><span class="p">,</span> <span class="s2">&quot;utrom&quot;</span><span class="p">,</span> <span class="s2">&quot;vampire&quot;</span><span class="p">,</span> <span class="s2">&quot;varmint&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vedalken&quot;</span><span class="p">,</span> <span class="s2">&quot;villain&quot;</span><span class="p">,</span> <span class="s2">&quot;volver&quot;</span><span class="p">,</span> <span class="s2">&quot;wall&quot;</span><span class="p">,</span> <span class="s2">&quot;walrus&quot;</span><span class="p">,</span> <span class="s2">&quot;warlock&quot;</span><span class="p">,</span>
    <span class="s2">&quot;warrior&quot;</span><span class="p">,</span> <span class="s2">&quot;weasel&quot;</span><span class="p">,</span> <span class="s2">&quot;weird&quot;</span><span class="p">,</span> <span class="s2">&quot;werewolf&quot;</span><span class="p">,</span> <span class="s2">&quot;whale&quot;</span><span class="p">,</span> <span class="s2">&quot;wizard&quot;</span><span class="p">,</span> <span class="s2">&quot;wolf&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wolverine&quot;</span><span class="p">,</span> <span class="s2">&quot;wombat&quot;</span><span class="p">,</span> <span class="s2">&quot;worm&quot;</span><span class="p">,</span> <span class="s2">&quot;wraith&quot;</span><span class="p">,</span> <span class="s2">&quot;wurm&quot;</span><span class="p">,</span> <span class="s2">&quot;yeti&quot;</span><span class="p">,</span> <span class="s2">&quot;zombie&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zubera&quot;</span><span class="p">,</span>
    <span class="c1"># Plural forms for common types (oracle text uses both)</span>
    <span class="s2">&quot;elves&quot;</span><span class="p">,</span>  <span class="c1"># &quot;Elves you control&quot; (elf → elves)</span>
<span class="p">}</span>

<span class="c1"># Pre-compile tribal context regex for creature type detection.</span>
<span class="c1"># Only fires CREATURE_TYPE_MATTERS when a creature type appears in a</span>
<span class="c1"># genuinely tribal context, NOT just in token creation text.</span>
<span class="c1"># Examples that SHOULD match: &quot;Dragon spells&quot;, &quot;whenever a Goblin enters&quot;</span>
<span class="c1"># Examples that should NOT match: &quot;create a 1/1 green Elf Warrior creature token&quot;</span>
<span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ALL_CREATURE_TYPES</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">TRIBAL_CONTEXT_PATTERNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &quot;[Type] spell(s)&quot; — &quot;Dragon spells&quot;, &quot;Goblin spell&quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\s+spells?\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;[Type] card(s)&quot; — &quot;search for a Dragon card&quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\s+cards?\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;cast a/an [Type]&quot; — &quot;whenever you cast a Dragon&quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;cast\s+(?:a|an)\s+(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;whenever a/an [Type]&quot; — tribal triggers</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;whenever\s+(?:a|an|another)\s+(?:\w+\s+)?(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;each [Type]&quot; — &quot;each Goblin gets +1/+1&quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;each\s+(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;number of [Type](s)&quot; — &quot;number of Zombies&quot;</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;number\s+of\s+(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)s?\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;target [Type]&quot; — type-specific targeting</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target\s+(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;sacrifice a/an [Type]&quot; — tribal cost</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;sacrifice\s+(?:a|an)\s+(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;[Type] creatures you control&quot; — broader lord pattern</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\s+creatures?\s+you\s+control&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;[Type] you control&quot; — already caught by existing pattern, but reinforces</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)s?\s+you\s+control&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;is a [Type]&quot; / &quot;becomes a [Type]&quot; — type assignment</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:is|becomes?)\s+(?:a|an)\s+(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;choose a [Type]&quot; / &quot;chosen [Type]&quot; — type selection</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:choose|chosen|named)\s+(?:a\s+)?(&quot;</span> <span class="o">+</span> <span class="n">_CREATURE_TYPE_PATTERN_STR</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)\b&quot;</span><span class="p">),</span>
<span class="p">]</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># NAMED MECHANIC UNDERLYING EFFECTS</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Maps ability words (named mechanics) to their actual underlying effects.</span>
<span class="c1"># These names appear in oracle text but their meaning isn&#39;t parseable from the name.</span>
<span class="c1"># &quot;Commit a crime&quot; = target something an opponent controls/owns → TARGET_OPPONENT</span>
<span class="c1"># &quot;Celebration&quot; = two+ nonland permanents entered this turn → ETB_TRIGGER</span>
<span class="c1"># We prefer mapping to underlying effects so set-unique names transfer knowledge.</span>

<span class="n">NAMED_MECHANIC_EFFECTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;commit a crime&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT</span><span class="p">],</span>               <span class="c1"># OTJ — target opponent&#39;s stuff</span>
    <span class="s2">&quot;celebration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ETB_TRIGGER</span><span class="p">],</span>                      <span class="c1"># WOE — two+ nonland permanents ETB&#39;d</span>
    <span class="s2">&quot;raid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACK_TRIGGER</span><span class="p">],</span>                          <span class="c1"># KTK — attacked with a creature this turn</span>
    <span class="s2">&quot;revolt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LTB_TRIGGER</span><span class="p">],</span>                           <span class="c1"># AER — permanent left battlefield</span>
    <span class="s2">&quot;morbid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATH_TRIGGER</span><span class="p">],</span>                         <span class="c1"># ISD — a creature died this turn</span>
    <span class="s2">&quot;eerie&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ETB_TRIGGER</span><span class="p">],</span>                            <span class="c1"># DSK — enchantment/room enters</span>
    <span class="s2">&quot;survival&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATH_TRIGGER</span><span class="p">],</span>                       <span class="c1"># DSK — two+ creatures died this turn</span>
    <span class="s2">&quot;valiant&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">],</span>                      <span class="c1"># BLB — targeted 2+ times</span>
    <span class="s2">&quot;landfall&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ETB_TRIGGER</span><span class="p">],</span>                         <span class="c1"># ZEN — land entered under your control</span>
    <span class="s2">&quot;constellation&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ETB_TRIGGER</span><span class="p">],</span>                    <span class="c1"># JOU — enchantment enters</span>
    <span class="s2">&quot;heroic&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">],</span>                       <span class="c1"># THS — you cast a spell targeting this</span>
    <span class="s2">&quot;magecraft&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COPY_SPELL</span><span class="p">],</span>                         <span class="c1"># STX — you cast/copy an instant/sorcery</span>
    <span class="s2">&quot;corrupted&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">POISON_COUNTER</span><span class="p">],</span>                     <span class="c1"># ONE — opponent has 3+ poison</span>
    <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COLOR_CONDITION</span><span class="p">],</span>                       <span class="c1"># INV — count basic land types</span>
    <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_GRAVEYARD</span><span class="p">],</span>                     <span class="c1"># ODY — 7+ cards in graveyard</span>
    <span class="s2">&quot;delirium&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_GRAVEYARD</span><span class="p">],</span>                      <span class="c1"># SOI — 4+ card types in graveyard</span>
    <span class="s2">&quot;metalcraft&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_ARTIFACT</span><span class="p">],</span>                   <span class="c1"># SOM — control 3+ artifacts</span>
    <span class="s2">&quot;ferocious&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">POWER_TOUGHNESS_CONDITION</span><span class="p">],</span>          <span class="c1"># KTK — control creature with power 4+</span>
    <span class="s2">&quot;hellbent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HAND_SIZE_MATTERS</span><span class="p">],</span>                   <span class="c1"># DIS — no cards in hand</span>
    <span class="s2">&quot;descend 4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_GRAVEYARD</span><span class="p">],</span>                     <span class="c1"># LCI — 4+ permanent cards in GY</span>
    <span class="s2">&quot;descend 8&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_GRAVEYARD</span><span class="p">],</span>                     <span class="c1"># LCI — 8+ permanent cards in GY</span>
<span class="p">}</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># TEXT PATTERN MATCHING</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># Generic number word pattern — used in draw, token, discard, mill patterns</span>
<span class="n">NUM</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:a|an|\d+|x|one|two|three|four|five|six|seven|eight|nine|ten)&quot;</span>

<span class="c1"># Patterns for common text structures</span>
<span class="n">PATTERNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Targeting patterns (compound BEFORE specific, opponent-specific BEFORE generic)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;any target&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_ANY</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PLAYER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PLANESWALKER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target creature or planeswalker&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PLANESWALKER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target (artifact or enchantment|enchantment or artifact)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_ARTIFACT</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_ENCHANTMENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target creature or enchantment&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_ENCHANTMENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target creature an opponent controls&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;creature an opponent controls&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target creature you don&#39;t control&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target creature you control&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_YOU_CONTROL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target (permanent|artifact|enchantment) you control&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PERMANENT</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_YOU_CONTROL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target creature&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target planeswalker&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PLANESWALKER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target player&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PLAYER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target opponent&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target .{0,30}(artifact|creature|permanent|enchantment).+opponent controls&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PERMANENT</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT_PERMANENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(artifact|creature|permanent|enchantment) an opponent controls&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT_PERMANENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(creatures?|permanents?|artifacts?|enchantments?|lands?) your opponents? controls?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT_CONTROLS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target permanent&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PERMANENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target spell&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_SPELL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target artifact&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_ARTIFACT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target enchantment&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_ENCHANTMENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target land&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_LAND</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target (spell or ability|ability)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_SPELL_OR_ABILITY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;target card (in|from) .{0,25}graveyard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CARD_IN_GRAVEYARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;each creature&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGETS_EACH</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;each opponent&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGETS_EACH</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_OPPONENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;all creatures&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGETS_ALL</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;each player&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGETS_EACH</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_PLAYER</span><span class="p">]),</span>

    <span class="c1"># Removal patterns</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;destroy (another )?(up to \w+ )?(target|all|each)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;destroys? (it|that|this|target)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exile target&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXILE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exiles? (it|that|this|target)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXILE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;sacrifice (a|an|target)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;return (it|that|target)(?!.*from .*(graveyard|exile)).+to (its|their|your|owner&#39;s) (hand|owner&#39;s hand)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BOUNCE_TO_HAND</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;put.+on (the bottom|top) of.+library&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BOUNCE_TO_LIBRARY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;counter target spell&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COUNTER_SPELL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;counter (it|that spell)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COUNTER_SPELL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;counter target.+ability&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COUNTER_ABILITY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;deals? (\d+|x) damage&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEAL_DAMAGE</span><span class="p">]),</span>
    <span class="c1"># Damage doublers/triplers (Gratuitous Violence, Fiery Emancipation)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;would deal damage.+deals? double that damage&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DAMAGE_DOUBLER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;would deal damage.+deals? triple that damage&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DAMAGE_DOUBLER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;deals? double.{0,20}damage instead&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DAMAGE_DOUBLER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;deals? triple.{0,20}damage instead&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DAMAGE_DOUBLER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;loses? (\d+|x) life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you lose life equal to&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE</span><span class="p">]),</span>

    <span class="c1"># Creation patterns</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;create(s)? &quot;</span> <span class="o">+</span> <span class="n">NUM</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; .*?(token|treasure|food|clue|blood)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;create(s)?.+cop(y|ies) of&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN_COPY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;create(s)?.+treasure token&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TREASURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;create(s)?.+food token&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_FOOD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;create(s)?.+clue token&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_CLUE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;create(s)?.+blood token&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_BLOOD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\binvestigate\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_CLUE</span><span class="p">]),</span>

    <span class="c1"># Card advantage</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;draw(s)? (&quot;</span> <span class="o">+</span> <span class="n">NUM</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; cards?|a card)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;may draw (&quot;</span> <span class="o">+</span> <span class="n">NUM</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; cards?|a card)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW_OPTIONAL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;scry (\d+|x)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SCRY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;surveil (\d+|x)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SURVEIL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;look at the top&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOOK_AT_TOP</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;reveal&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">REVEAL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;search your library&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_TO_HAND</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;search your library.+put.+onto the battlefield&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_TO_BATTLEFIELD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;return.+from.+graveyard to the battlefield&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">REANIMATE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;return.+from.+graveyard to your hand&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">REGROWTH</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;discard(s)? (&quot;</span> <span class="o">+</span> <span class="n">NUM</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; cards?|a card|your hand|that card|it|them)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;mills?\s+&quot;</span> <span class="o">+</span> <span class="n">NUM</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+cards?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MILL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you may cast.+from.+graveyard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;cast .+from (your|a|the) graveyard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;play .+from (your|a|the) graveyard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_GRAVEYARD</span><span class="p">]),</span>

    <span class="c1"># Loot / Rummage (draw+discard combo)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;draw.{1,20}then.{1,10}discard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOOT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;discard.{1,20}then.{1,10}draw&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOOT</span><span class="p">]),</span>

    <span class="c1"># Triggers</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ enters( the battlefield)?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ETB_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ leaves( the battlefield)?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LTB_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ dies&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATH_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;is put into a graveyard from the battlefield&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEATH_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ attacks?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACK_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ blocks&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BLOCK_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ becomes? blocked&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BLOCK_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ deals (combat )?damage&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DAMAGE_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ is dealt damage&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DAMAGE_RECEIVED_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? you cast&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? an opponent casts&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">OPPONENT_CASTS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;at the beginning of your upkeep&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">UPKEEP_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;at the beginning of combat on your turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BEGINNING_OF_COMBAT_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;at the beginning of (each|your) end step&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">END_STEP_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? you draw&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? you gain or lose life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_LIFE_TRIGGER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? you gain life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_LIFE_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? you lose life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? a land enters&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LANDFALL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(ever)? .+ deals combat damage to a player&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COMBAT_DAMAGE_TO_PLAYER</span><span class="p">]),</span>

    <span class="c1"># Conditions</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if .+ dies this way&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IF_TARGET_DIES</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if you control a commander&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IF_YOU_CONTROL_COMMANDER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if you control (a|an) creature&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IF_YOU_CONTROL_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if you control (a|an) artifact&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IF_YOU_CONTROL_ARTIFACT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if you control (a|an) enchantment&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IF_YOU_CONTROL_ENCHANTMENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if a creature (entered|died)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IF_CREATURE_ENTERED</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if you(&#39;ve)? gained.+life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IF_LIFE_GAINED</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;unless (that player|they) pays?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">UNLESS_PAYS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;was dealt damage this turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEALT_DAMAGE_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if you control (\w+) or more&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">THRESHOLD_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(for each|of that|of the chosen|from .{0,10}) color&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COLOR_CONDITION</span><span class="p">]),</span>

    <span class="c1"># Stats modification (digits or X)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gets? \+([1-9]\d*|x)/\+([1-9]\d*|x)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_POWER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_TOUGHNESS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gets? -([1-9]\d*|x)/-([1-9]\d*|x)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_POWER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_TOUGHNESS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gets? \+(\d+|x)/\+0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_POWER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gets? \+0/\+(\d+|x)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_TOUGHNESS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gets? -(\d+|x)/-0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_POWER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gets? -0/-(\d+|x)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_TOUGHNESS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(other )?(creatures|permanents) you control get \+&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ANTHEM_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\+1/\+1 counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-1/-1 counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_ONE_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;half.+(power|toughness)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HALF_STATS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;double.+(power|toughness)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DOUBLE_STATS</span><span class="p">]),</span>

    <span class="c1"># Mana</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;add \{&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;add (one|two|three|\d+) mana&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;mana of any (color|type)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_OF_ANY_COLOR</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_FIXING</span><span class="p">]),</span>
    <span class="c1"># Fetch lands searching for two land types → MANA_FIXING</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;search.{0,40}(plains|island|swamp|mountain|forest).{0,15}or\s+(plains|island|swamp|mountain|forest)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_FIXING</span><span class="p">]),</span>
    <span class="c1"># &quot;tap for any color&quot; variant phrasing</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;tap.{0,20}for mana of any color&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_FIXING</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;costs? \{?\d+\}? less to cast&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">REDUCE_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;costs? \{?\d+\}? more to cast&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">INCREASE_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;without paying (its|their) mana cost&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FREE_CAST_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you may cast.+without paying&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FREE_CAST_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you may choose new targets&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CHANGE_TARGETS</span><span class="p">]),</span>

    <span class="c1"># Special effects</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gains? protection&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PROTECTION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t be blocked\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">UNBLOCKABLE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t be countered&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_BE_COUNTERED</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;tap target&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TAP</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;untap (target|it|them|\w+)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">UNTAP</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;fight(s)?&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FIGHT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;proliferate&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PROLIFERATE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;twice that many&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOKEN_DOUBLER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;trigger(s)? an additional time&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DOUBLE_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;instead&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;prevent(s)? (all )?(the next )?\d* ?damage&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PREVENT_DAMAGE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;prevent(s)? all (combat )?damage&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PREVENT_DAMAGE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;damage.+(be )?prevented&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PREVENT_DAMAGE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gain control of&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_CONTROL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gains? control of&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_CONTROL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exchange control&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_CONTROL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:return|put).{0,80}under your control&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_CONTROL</span><span class="p">]),</span>  <span class="c1"># theft, not &quot;entered under your control&quot;</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;crew\s+\d+&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exile the top.+(you|they|that player) may (play|cast)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IMPULSE_DRAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exile.+from the top.+(you|they|that player) may (play|cast)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IMPULSE_DRAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exile the top.+until end of turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IMPULSE_DRAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exile.+cards?.+(you|they|that player) may (play|cast) (those|them|that)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IMPULSE_DRAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;phases? out&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PHASE_OUT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;take an extra turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXTRA_TURN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;extra turn after this one&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXTRA_TURN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you win the game&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">WIN_GAME</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(target player|that player|opponent) loses the game&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_GAME</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you lose the game&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_GAME</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as an additional cost.+sacrifice&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">]),</span>

    <span class="c1"># Gain control variants</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(forestwalk|islandwalk|swampwalk|mountainwalk|plainswalk)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LANDWALK</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;no more than (one|two|\d+) creatures? can (attack|block)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COMBAT_RESTRICTION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;only one creature can (attack|block)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COMBAT_RESTRICTION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enters? (the battlefield )?with (\w+ ){0,3}\+1/\+1 counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ENTERS_WITH_COUNTERS</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enters? (the battlefield )?with (\w+ ){0,3}-1/-1 counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ENTERS_WITH_COUNTERS</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MINUS_ONE_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enters? (the battlefield )?with (\w+ ){0,3}counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ENTERS_WITH_COUNTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;flip a coin&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COIN_FLIP</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;regenerate&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">REGENERATE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enters? as a copy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COPY_PERMANENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;becomes? a copy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COPY_PERMANENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;stun counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">STUN_COUNTER</span><span class="p">]),</span>

    <span class="c1"># Zones</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;from your hand&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_HAND</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;from (your|a|the) graveyard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_GRAVEYARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;from exile&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_EXILE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;from (your|the top of your) library&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FROM_LIBRARY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;put.+into (your|the) graveyard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TO_GRAVEYARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;exile.+until&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXILE_TEMPORARY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you may cast.+from exile&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_FROM_EXILE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enters (the battlefield )?tapped&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TO_BATTLEFIELD_TAPPED</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;onto the battlefield tapped&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TO_BATTLEFIELD_TAPPED</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># MODAL / CHOICE</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;choose one&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MODAL_CHOOSE_ONE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;choose two&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MODAL_CHOOSE_TWO</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;choose three&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MODAL_CHOOSE_THREE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;choose (up to )?(one or more|any number|x)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MODAL_CHOOSE_X</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># RECENT SET MECHANICS</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;spree\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SPREE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;offspring\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">OFFSPRING</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\beerie\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EERIE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bsurvival\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SURVIVAL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;impending\s+\d+&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">IMPENDING</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bbargain\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BARGAIN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bcelebrat(e|ion)\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CELEBRATION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\brole\b.+\btoken\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ROLE_TOKEN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bcase\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CASE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bsuspect\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SUSPECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bcloak\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CLOAK</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bconnive[sd]?\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CONNIVE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;collect evidence\s+\d+&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COLLECT_EVIDENCE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;commit(ted|s)? a crime&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">COMMIT_A_CRIME</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;saddle\s+\d+&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SADDLE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gift a\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GIFT</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bdescend 4\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DESCEND_4</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bdescend 8\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DESCEND_8</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;fathomless descent&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FATHOMLESS_DESCENT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bmap token&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MAP_TOKEN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bvaliant\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">VALIANT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\boutlaw\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">OUTLAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bescalate\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ESCALATE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\btiered\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ESCALATE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bcycling\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CYCLING</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bexert\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXERT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;play an additional land&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXTRA_LAND_PLAY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bvoid\b\s*—&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">VOID</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\broom\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ROOM</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bbehold\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">REVEAL</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATURE_TYPE_MATTERS</span><span class="p">]),</span>

    <span class="c1"># Face-down mechanics — morph/manifest/disguise/cloak text references</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;face[- ]down&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;face[- ]up&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;turned? face[- ]up&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;is turned face[- ]down&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FACE_DOWN_MATTERS</span><span class="p">]),</span>

    <span class="c1"># Land tutoring / ramp</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;search.{0,30}(for|your library).{0,30}basic land&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;search.{0,30}(for|your library).{0,30}(land card|forest|plains|island|swamp|mountain)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_LAND</span><span class="p">]),</span>

    <span class="c1"># Your-turn condition</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if it&#39;s your turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">YOUR_TURN_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;during your turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">YOUR_TURN_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;on your turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">YOUR_TURN_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;only during your turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">YOUR_TURN_CONDITION</span><span class="p">]),</span>

    <span class="c1"># Spacecraft → word-consuming (artifact creature subtype, no special mechanic)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bspacecraft\b&quot;</span><span class="p">,</span> <span class="p">[]),</span>

    <span class="c1"># Unnamed cost patterns (not keyword-specific)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as an additional cost.+discard&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as an additional cost.+pay.+life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PAY_LIFE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as an additional cost.+exile&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EXILE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as an additional cost.+tap&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADDITIONAL_COST</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TAP</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;rather than pay (this spell&#39;s|its) mana cost&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you may pay .+ rather than&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ALTERNATIVE_COST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you may pay \{[^}]+\}\.\s*if you do&quot;</span><span class="p">,</span> <span class="p">[]),</span>  <span class="c1"># word-consuming: conditional pay</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># QUIZ ROUND 2 DESIGN DECISIONS</span>
    <span class="c1"># =========================================================================</span>

    <span class="c1"># Creature type matters / tribal synergy — &quot;[type]s you control&quot; where [type] is not generic</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(?:other )?(?!creatures?\b|permanents?\b|artifacts?\b|enchantments?\b|lands?\b|spells?\b|cards?\b|tokens?\b|players?\b|nonland|noncreature|nontoken|legendary|it\b|they\b|them\b|that\b|this\b|those\b|each\b|all\b|target\b)\w+s? you control&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATURE_TYPE_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if you control (?:a|an) (?!creature|permanent|artifact|enchantment|land|spell|card|token|player|nonland|noncreature)\w+&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATURE_TYPE_MATTERS</span><span class="p">]),</span>

    <span class="c1"># Dies → return to battlefield (self-recurring, NOT persist/undying keyword)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when .{1,30} dies, return .{1,30} to the battlefield&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DIES_TO_BATTLEFIELD</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when .{1,30} dies, put .{1,30} onto the battlefield&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DIES_TO_BATTLEFIELD</span><span class="p">]),</span>

    <span class="c1"># Finality counter</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;finality counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FINALITY_COUNTER</span><span class="p">]),</span>

    <span class="c1"># Once per turn restriction</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;this ability triggers only once each turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ONCE_PER_TURN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;activate .{0,20}only once each turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ONCE_PER_TURN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;activate .{0,30}only once\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ONCE_PER_TURN</span><span class="p">]),</span>  <span class="c1"># exhaust reminder text</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bexhaust\b.{0,5}—&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ONCE_PER_TURN</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ACTIVATED_ABILITY</span><span class="p">]),</span>  <span class="c1"># exhaust keyword ability</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;activate.+only as a sorcery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SORCERY_SPEED</span><span class="p">]),</span>

    <span class="c1"># Pay life as cost/condition</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;pay (\d+|x) life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PAY_LIFE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;pays? (\d+|x) life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">PAY_LIFE</span><span class="p">]),</span>

    <span class="c1"># Toughness-matters — Assault Formation, Doran, defenders</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;equal to .{0,30}toughness&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;total toughness&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;toughness among&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;with the greatest toughness&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;with the least toughness&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;assign .{0,20}toughness&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;toughness rather than.{0,10}power&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;deals? combat damage equal to its toughness&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TOUGHNESS_MATTERS</span><span class="p">]),</span>

    <span class="c1"># Power/toughness condition (stat gate)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:power|toughness) \d+ or (?:greater|more|less)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">POWER_TOUGHNESS_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;with (?:power|toughness) \d+ or (?:greater|more|less)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">POWER_TOUGHNESS_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:power|toughness) (?:equal to|less than|greater than)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">POWER_TOUGHNESS_CONDITION</span><span class="p">]),</span>

    <span class="c1"># Effect multiplier — Doubling Season, Parallel Lives, Ojer Taq</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(twice|double|two times) that many&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EFFECT_MULTIPLIER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(three|four|five|\d+) times that many&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EFFECT_MULTIPLIER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(twice|double) the number of&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EFFECT_MULTIPLIER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;tokens? (are|is) created instead&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EFFECT_MULTIPLIER</span><span class="p">]),</span>

    <span class="c1"># Mana value condition — &quot;mana value N or less/more&quot;</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;mana value.{0,10}(\d+|x) or (less|fewer|more|greater)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_VALUE_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;mana value.{0,10}(less than|greater than|equal to)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_VALUE_CONDITION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(converted mana cost|mana value) (is |was )?\d+&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_VALUE_CONDITION</span><span class="p">]),</span>

    <span class="c1"># Hand size matters — &quot;for each card in your hand&quot;</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;for each card in (your|their|a player&#39;s) hand&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HAND_SIZE_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;cards? in (your|their) hand&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HAND_SIZE_MATTERS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(equal to|less than|greater than) the number of cards in&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">HAND_SIZE_MATTERS</span><span class="p">]),</span>

    <span class="c1"># Grants ability — lord/equipment granting keywords to others</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+s? you control (have|gain) &quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GRANTS_ABILITY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;equipped creature (has|gains) &quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GRANTS_ABILITY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as though (they|it) had &quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GRANTS_ABILITY</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># TYPE FILTERS</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bnonland\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FILTER_NONLAND</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bnoncreature\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FILTER_NONCREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bnontoken\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FILTER_NONTOKEN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bnonartifact\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">FILTER_NONARTIFACT</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># DURATION MARKERS</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;until end of turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">UNTIL_END_OF_TURN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;until your next turn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">UNTIL_YOUR_NEXT_TURN</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as long as&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">AS_LONG_AS</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># LIFE GAIN</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gains?\s+\d+\s+life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_LIFE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you gain\s+\d+\s+life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_LIFE</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># VARIABLE EFFECTS (&quot;where X is&quot; / &quot;equal to&quot; / &quot;for each&quot;)</span>
    <span class="c1"># =========================================================================</span>
    <span class="c1"># Variable draw</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;draw(s)?\s+(a\s+)?cards?\s+for\s+each&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;draw(s)?\s+\w+\s+cards?,?\s+where&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;draw(s)?\s+cards?\s+equal\s+to&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span><span class="p">]),</span>

    <span class="c1"># Variable damage</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;deals?\s+damage\s+(to\s+.+?\s+)?equal\s+to&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEAL_DAMAGE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;deals?\s+\w+\s+damage.+?where\s+\w+\s+is&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEAL_DAMAGE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;deals?\s+damage\s+to\s+.+?\s+for\s+each&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DEAL_DAMAGE</span><span class="p">]),</span>

    <span class="c1"># Variable life loss/gain</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;loses?\s+life\s+equal\s+to&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;loses?\s+\w+\s+life,?\s+where&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gains?\s+life\s+equal\s+to&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GAIN_LIFE</span><span class="p">]),</span>

    <span class="c1"># Variable mill</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;mills?\s+\w+\s+cards?,?\s+where&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MILL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;mills?\s+cards?\s+equal\s+to&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MILL</span><span class="p">]),</span>

    <span class="c1"># Variable scry/surveil</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;scry\s+\w+,?\s+where&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SCRY</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;surveil\s+\w+,?\s+where&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SURVEIL</span><span class="p">]),</span>

    <span class="c1"># Variable tokens</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;create\s+.*?\s+tokens?\s+for\s+each&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># EQUIPMENT</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;equipped creature&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EQUIP</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># COUNTER TYPES</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;experience counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXPERIENCE_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{e\}|energy counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ENERGY_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;shield counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SHIELD_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;oil counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">OIL_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;charge counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CHARGE_COUNTER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(flying|first strike|double strike|deathtouch|lifelink|vigilance|reach|trample|haste|menace|hexproof|indestructible) counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">KEYWORD_COUNTER</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># BECOMES CREATURE (manlands, Gideon, etc.)</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;becomes?\s+a?\s*\d+/\d+.*creature&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BECOMES_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;is\s+(a|an)\s+.*creature.*as long as&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BECOMES_CREATURE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">AS_LONG_AS</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># AURA / ENCHANTMENT EFFECTS</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enchant creature&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_CREATURE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enchant (permanent|artifact|land|player)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enchanted creature&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;enchanted permanent&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t attack or block&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_ATTACK</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_BLOCK</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t attack\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_ATTACK</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t block\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_BLOCK</span><span class="p">]),</span>
    <span class="c1"># Forced combat patterns</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;attacks each (combat|turn) if able&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACKS_EACH_COMBAT</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MUST_ATTACK</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;must attack\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MUST_ATTACK</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACKS_EACH_COMBAT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;must be blocked\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MUST_BE_BLOCKED</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;blocks?.{0,20}if able&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MUST_BE_BLOCKED</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;all creatures.{0,20}attack each&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACKS_EACH_COMBAT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;is goaded&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GOAD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACKS_EACH_COMBAT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;goaded&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GOAD</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ATTACKS_EACH_COMBAT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;base power and toughness (\d+)/(\d+)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SET_POWER</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SET_TOUGHNESS</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;loses all (other )?abilities&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSES_ABILITIES</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># STAX / HATE EFFECTS</span>
    <span class="c1"># =========================================================================</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t gain life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_GAIN_LIFE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t be cast&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_CAST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t cast\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_CAST</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t cast more than one&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_RESTRICTION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t cast additional&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_RESTRICTION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can cast only&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CAST_RESTRICTION</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;would draw.+instead&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW_REPLACEMENT</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;can&#39;t enter the battlefield&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GRAVEYARD_HATE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if a card.+would be put into a graveyard.+exile&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GRAVEYARD_HATE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;shuffles?.{0,30}graveyard into.{0,15}library&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">GRAVEYARD_SHUFFLE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">GRAVEYARD_HATE</span><span class="p">]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># WORD-CONSUMING PATTERNS (no mechanics, just improve confidence)</span>
    <span class="c1"># =========================================================================</span>
    <span class="c1"># These patterns match common MTG phrases that follow variable effects.</span>
    <span class="c1"># They don&#39;t emit mechanics but consume words so confidence scoring</span>
    <span class="c1"># correctly reflects that this text has been understood.</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;where\s+\w+\s+is\s+the\s+number\s+of&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;equal\s+to\s+the\s+number\s+of&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;equal\s+to\s+(its|that\s+creature&#39;s|that\s+card&#39;s)\s+(power|toughness|mana\s+value|converted\s+mana\s+cost)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;for\s+each\s+(creature|land|artifact|enchantment|permanent|card|instant|sorcery|spell|player|opponent|color)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(creatures?|lands?|artifacts?|enchantments?|permanents?|cards?)\s+(you\s+control|in\s+your\s+graveyard|in\s+your\s+hand)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(creatures?|lands?|artifacts?|enchantments?|permanents?|cards?)\s+your\s+opponents?\s+controls?&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(you\s+control|your\s+opponents?\s+controls?)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;in\s+(your|the)\s+(graveyard|hand|library|exile)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;that\s+(died|entered|left)\s+this\s+turn&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;among\s+(creatures|permanents|cards)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(any|another|each|a|that)\s+target&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;in\s+addition\s+to\s+its\s+other\s+types?&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;put\s+a\s+\+1/\+1\s+counter\s+on&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;activate\s+(this\s+ability\s+)?only&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;this\s+(creature|spell|card|permanent)\s+(enters|costs?)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{t\}:\s+add\s+\{?[wubrgc]\}?&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;would\s+gain\s+life.+loses\s+that\s+much\s+life&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CANT_GAIN_LIFE</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">REPLACEMENT_EFFECT</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;cycling\s+(\{[^}]+\})+&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;whenever\s+you\s+cycle&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DISCARD_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;destroy\s+all\s+(creatures|permanents|artifacts|enchantments)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGETS_ALL</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(tap|untap)\s+all\s+&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;under\s+(your|its\s+owner&#39;s)\s+control&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(its|their)\s+owner&#39;s\s+hand&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;any\s+(number|combination)\s+of&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;whenever\s+you\s+tap\s+a\s+\w+\s+for\s+mana&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_DOUBLER</span><span class="p">]),</span>

    <span class="c1"># Explore (LCI, BLB, etc.)</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;it\s+explores&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXPLORE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;explores?\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EXPLORE</span><span class="p">]),</span>

    <span class="c1"># Leylines</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if this card is in your opening hand.+begin the game with it on the battlefield&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LEYLINE</span><span class="p">]),</span>

    <span class="c1"># DSK Rooms</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(fully )?unlock(s|ed)?\s+(a|this)\s+room&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">UNLOCK_ROOM</span><span class="p">]),</span>

    <span class="c1"># Shockland / painland entry</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;as\s+this\s+land\s+enters,?\s+you\s+may\s+pay\s+\d+\s+life&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if\s+you\s+don&#39;t,?\s+it\s+enters\s+tapped&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TO_BATTLEFIELD_TAPPED</span><span class="p">]),</span>

    <span class="c1"># Common &quot;gains [keyword]&quot; confidence booster</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;gains?\s+(flying|trample|first strike|double strike|deathtouch|lifelink|vigilance|reach|haste|menace|hexproof|indestructible)&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(it|that creature|this creature)\s+gains?\s+&quot;</span><span class="p">,</span> <span class="p">[]),</span>

    <span class="c1"># Fetch land patterns</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;sacrifice\s+this\s+(land|artifact|creature|enchantment|permanent)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;for\s+a\s+basic\s+land\s+card&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;put\s+it\s+onto\s+the\s+battlefield\s+tapped&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TO_BATTLEFIELD_TAPPED</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;then\s+shuffle&quot;</span><span class="p">,</span> <span class="p">[]),</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># QUICK-WIN PATTERN WIRING (zero-hit enums)</span>
    <span class="c1"># =========================================================================</span>

    <span class="c1"># Sacrifice trigger — &quot;whenever you sacrifice&quot; / &quot;when you sacrifice&quot; / &quot;is sacrificed&quot;</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;when(?:ever)? .{0,30}sacrifice&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE_TRIGGER</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;is sacrificed&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SACRIFICE_TRIGGER</span><span class="p">]),</span>

    <span class="c1"># The Ring — &quot;the ring tempts you&quot;</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;the ring tempts you&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">THE_RING</span><span class="p">]),</span>

    <span class="c1"># Voting / council mechanics</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bvotes?\b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">VOTING</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;council&#39;s dilemma&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">VOTING</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">COUNCIL_DILEMMA</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;will of the council&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">VOTING</span><span class="p">,</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">WILL_OF_COUNCIL</span><span class="p">]),</span>

    <span class="c1"># Time counters — suspend/vanishing use them</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;time counter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TIME_COUNTER</span><span class="p">]),</span>

    <span class="c1"># Target up to X — &quot;up to N target&quot;</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;up to (\w+) target&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TARGET_UP_TO_X</span><span class="p">]),</span>

    <span class="c1"># Tutor to top of library — &quot;search your library...put...on top&quot;</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;search your library.{0,80}put.{0,40}on top&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_TO_TOP</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;put .{0,20}on top of (your|their) library.{0,20}shuffle&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TUTOR_TO_TOP</span><span class="p">]),</span>

    <span class="c1"># Common text fragments</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;at\s+the\s+beginning\s+of\s+(your|the)\s+(first|second|next)\s+main\s+phase&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;return\s+(?!.*from .*(graveyard|exile)).+?\s+to\s+(its|their)\s+owner&#39;s\s+hand&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">BOUNCE_TO_HAND</span><span class="p">]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;you\s+may\s+(cast|play)\s+it&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;if\s+you\s+do,?\s+&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;attach\s+it\s+to\s+&quot;</span><span class="p">,</span> <span class="p">[]),</span>
<span class="p">]</span>

<span class="c1"># Pre-compile all patterns at module load for ~19x speedup</span>
<span class="c1"># (avoids re.search recompiling 343+ patterns on every call)</span>
<span class="n">PATTERNS</span> <span class="o">=</span> <span class="p">[(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">PATTERNS</span><span class="p">]</span>

<span class="c1"># Pre-compile keyword ability patterns (dynamic word-boundary patterns)</span>
<span class="n">_COMPILED_KEYWORD_PATTERNS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Mechanic&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!without )(?&lt;!lose )(?&lt;!loses )\b&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">),</span> <span class="n">kw</span><span class="p">,</span> <span class="n">mech</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">mech</span> <span class="ow">in</span> <span class="n">KEYWORD_ABILITIES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">]</span>

<span class="c1"># Pre-compile token implication patterns</span>
<span class="n">_COMPILED_TOKEN_PATTERNS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">token_type</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">),</span> <span class="n">token_type</span><span class="p">,</span> <span class="n">effects</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">token_type</span><span class="p">,</span> <span class="n">effects</span> <span class="ow">in</span> <span class="n">TOKEN_IMPLICATIONS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">]</span>

<span class="c1"># Pre-compile named mechanic effect patterns</span>
<span class="n">_COMPILED_NAMED_MECHANIC_PATTERNS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">),</span> <span class="n">effects</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">effects</span> <span class="ow">in</span> <span class="n">NAMED_MECHANIC_EFFECTS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">]</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># PARSER</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="strip_reminder_text">
<a class="viewcode-back" href="../../../api/mechanics.html#src.mechanics.card_parser.strip_reminder_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">strip_reminder_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strip parenthetical reminder text from oracle text.</span>

<span class="sd">    Reminder text in MTG cards appears in parentheses and explains mechanics</span>
<span class="sd">    but doesn&#39;t represent parseable abilities. Stripping it before word</span>
<span class="sd">    counting prevents artificial confidence deflation.</span>

<span class="sd">    Example: &quot;Flying (This creature can&#39;t be blocked except by creatures</span>
<span class="sd">    with flying or reach.)&quot; -&gt; &quot;Flying &quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\([^)]*\)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>



<div class="viewcode-block" id="ParseResult">
<a class="viewcode-back" href="../../../api/mechanics.html#src.mechanics.card_parser.ParseResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ParseResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of parsing card text.&quot;&quot;&quot;</span>
    <span class="n">mechanics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Mechanic</span><span class="p">]</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1, how confident we are in the parse</span>
    <span class="n">unparsed_text</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Text we couldn&#39;t parse (for LLM fallback)</span></div>



<div class="viewcode-block" id="parse_oracle_text">
<a class="viewcode-back" href="../../../api/mechanics.html#src.mechanics.card_parser.parse_oracle_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_oracle_text</span><span class="p">(</span><span class="n">oracle_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">card_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">card_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParseResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse oracle text into mechanics sequence.</span>

<span class="sd">    Args:</span>
<span class="sd">        oracle_text: The card&#39;s oracle text</span>
<span class="sd">        card_type: The card&#39;s type line (e.g., &quot;Instant&quot;, &quot;Creature — Human Wizard&quot;)</span>
<span class="sd">        card_name: The card&#39;s name (for self-reference stripping)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ParseResult with mechanics, parameters, and confidence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">oracle_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">strip_reminder_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># Strip card self-references to reduce unparsed noise</span>
    <span class="c1"># &quot;Atraxa, Grand Unifier enters&quot; → &quot;this creature enters&quot;</span>
    <span class="k">if</span> <span class="n">card_name</span><span class="p">:</span>
        <span class="n">card_name_lower</span> <span class="o">=</span> <span class="n">card_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Handle DFC names (&quot;Front // Back&quot;)</span>
        <span class="k">for</span> <span class="n">name_part</span> <span class="ow">in</span> <span class="n">card_name_lower</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; // &quot;</span><span class="p">):</span>
            <span class="n">name_part</span> <span class="o">=</span> <span class="n">name_part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_part</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Avoid stripping tiny names like &quot;It&quot;</span>
                <span class="c1"># Determine replacement based on card type</span>
                <span class="k">if</span> <span class="s2">&quot;creature&quot;</span> <span class="ow">in</span> <span class="n">card_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="s2">&quot;this creature&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;instant&quot;</span> <span class="ow">in</span> <span class="n">card_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;sorcery&quot;</span> <span class="ow">in</span> <span class="n">card_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="s2">&quot;this spell&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;planeswalker&quot;</span> <span class="ow">in</span> <span class="n">card_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="s2">&quot;this planeswalker&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;land&quot;</span> <span class="ow">in</span> <span class="n">card_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="s2">&quot;this land&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="s2">&quot;this permanent&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">name_part</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
    <span class="n">mechanics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">matched_spans</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Determine base timing from card type</span>
    <span class="n">card_type_lower</span> <span class="o">=</span> <span class="n">card_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;instant&quot;</span> <span class="ow">in</span> <span class="n">card_type_lower</span><span class="p">:</span>
        <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">INSTANT_SPEED</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;sorcery&quot;</span> <span class="ow">in</span> <span class="n">card_type_lower</span><span class="p">:</span>
        <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SORCERY_SPEED</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">card_type_lower</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;creature&quot;</span><span class="p">,</span> <span class="s2">&quot;artifact&quot;</span><span class="p">,</span> <span class="s2">&quot;enchantment&quot;</span><span class="p">,</span> <span class="s2">&quot;planeswalker&quot;</span><span class="p">]):</span>
        <span class="c1"># Permanents can have static/triggered/activated abilities</span>
        <span class="k">if</span> <span class="s2">&quot;when&quot;</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;whenever&quot;</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;at the beginning&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">TRIGGERED_ABILITY</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>  <span class="c1"># Activated ability pattern</span>
            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ACTIVATED_ABILITY</span><span class="p">)</span>

    <span class="c1"># Check for keyword abilities (pre-compiled patterns)</span>
    <span class="k">for</span> <span class="n">kw_pattern</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">mechanic</span> <span class="ow">in</span> <span class="n">_COMPILED_KEYWORD_PATTERNS</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">kw_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="c1"># Check if keyword is in a &quot;lose/loses&quot; clause (e.g. &quot;lose hexproof and indestructible&quot;)</span>
            <span class="n">preceding</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">-</span> <span class="mi">50</span><span class="p">):</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bloses?\s+(?:\w+[\s,]+(?:and\s+)?)*$&#39;</span><span class="p">,</span> <span class="n">preceding</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mechanic</span><span class="p">)</span>
            <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>

            <span class="c1"># Add cost category (ADDITIONAL_COST / ALTERNATIVE_COST / REDUCE_COST)</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">KEYWORD_COST_CATEGORY</span><span class="p">:</span>
                <span class="n">cost_cat</span> <span class="o">=</span> <span class="n">KEYWORD_COST_CATEGORY</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cost_cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_cat</span><span class="p">)</span>

            <span class="c1"># Add implied effects (what the reminder text describes)</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">KEYWORD_IMPLICATIONS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">KEYWORD_IMPLICATIONS</span><span class="p">[</span><span class="n">keyword</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">implied</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                        <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">implied</span><span class="p">)</span>

    <span class="c1"># Fire token implied effects (Food → GAIN_LIFE+SACRIFICE, etc.)</span>
    <span class="k">for</span> <span class="n">token_pattern</span><span class="p">,</span> <span class="n">token_type</span><span class="p">,</span> <span class="n">implied_effects</span> <span class="ow">in</span> <span class="n">_COMPILED_TOKEN_PATTERNS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">implied</span> <span class="ow">in</span> <span class="n">implied_effects</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">implied</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">implied</span><span class="p">)</span>

    <span class="c1"># Fire named mechanic underlying effects (commit a crime → TARGET_OPPONENT, etc.)</span>
    <span class="k">for</span> <span class="n">named_pattern</span><span class="p">,</span> <span class="n">underlying_effects</span> <span class="ow">in</span> <span class="n">_COMPILED_NAMED_MECHANIC_PATTERNS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">named_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">effect</span> <span class="ow">in</span> <span class="n">underlying_effects</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">effect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span>

    <span class="c1"># Creature type tribal detection (context-filtered)</span>
    <span class="c1"># Only fires when a creature type appears in a genuinely tribal context,</span>
    <span class="c1"># NOT in token creation text like &quot;create a 1/1 green Elf Warrior creature token&quot;</span>
    <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATURE_TYPE_MATTERS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tribal_pattern</span> <span class="ow">in</span> <span class="n">TRIBAL_CONTEXT_PATTERNS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tribal_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATURE_TYPE_MATTERS</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="c1"># Extract numeric parameters from keyword abilities</span>
    <span class="c1"># Ward N</span>
    <span class="n">ward_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ward\s*\{(\d+)\}&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ward_match</span><span class="p">:</span>
        <span class="n">ward_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ward\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ward_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ward_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ward_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Toxic N</span>
    <span class="n">toxic_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;toxic\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">toxic_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;toxic_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toxic_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Annihilator N</span>
    <span class="n">annih_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;annihilator\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annih_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;annihilator_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">annih_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Kicker {N} or kicker cost</span>
    <span class="n">kicker_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;kicker\s*\{(\d+)\}&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kicker_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;kicker_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kicker_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Apply text patterns (pre-compiled at module load)</span>
    <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">mechs</span> <span class="ow">in</span> <span class="n">PATTERNS</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

            <span class="c1"># Extract numeric parameters</span>
            <span class="n">word_to_num</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;an&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;one&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                           <span class="s2">&quot;four&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;five&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;six&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;seven&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                           <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">}</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
            <span class="c1"># Also check for word numbers in the match</span>
            <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">word_to_num</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">numbers</span><span class="p">:</span>
                    <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">numbers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW</span> <span class="ow">in</span> <span class="n">mechs</span> <span class="ow">or</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DRAW_OPTIONAL</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;draw_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                <span class="k">elif</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">DEAL_DAMAGE</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;damage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                <span class="k">elif</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_TOKEN</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="c1"># Strip P/T patterns (e.g., &quot;3/1&quot;) to avoid confusing P/T with token count</span>
                    <span class="n">match_text_no_pt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+/\d+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
                    <span class="n">token_nums</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">match_text_no_pt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">token_nums</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;token_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token_nums</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">token_nums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Word number like &quot;a&quot; or &quot;two&quot; — use word_to_num</span>
                        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">word_to_num</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">match_text_no_pt</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                                <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;token_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                                <span class="k">break</span>
                <span class="k">elif</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SCRY</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;scry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                <span class="k">elif</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MILL</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mill_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                <span class="k">elif</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SURVEIL</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;surveil_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                <span class="k">elif</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOSE_LIFE</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;life_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span>
                <span class="k">elif</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">PLUS_ONE_COUNTER</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="c1"># Try to extract counter count from surrounding text</span>
                    <span class="n">counter_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)\s+\+1/\+1 counter&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">counter_match</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;counter_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">counter_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># Extract stat modifiers from +X/+Y or -X/-Y patterns</span>
            <span class="n">stat_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;gets?\s+([+-])(\d+)/([+-])(\d+)&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">stat_match</span><span class="p">:</span>
                <span class="n">p_sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">stat_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">t_sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">stat_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># Check if this stat modification is variable (&quot;for each&quot; / &quot;equal to&quot;)</span>
                <span class="c1"># Look at surrounding text since &quot;for each&quot; may be outside the match group</span>
                <span class="n">stat_pos</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">stat_match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
                <span class="n">nearby_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stat_pos</span><span class="p">):</span><span class="n">stat_pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat_match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span> <span class="o">+</span> <span class="mi">40</span><span class="p">]</span> <span class="k">if</span> <span class="n">stat_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(for each|equal to)&#39;</span><span class="p">,</span> <span class="n">nearby_text</span><span class="p">):</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;power_mod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;toughness_mod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p_val</span> <span class="o">=</span> <span class="n">p_sign</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">stat_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">t_val</span> <span class="o">=</span> <span class="n">t_sign</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">stat_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">p_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;power_mod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span>
                    <span class="k">if</span> <span class="n">t_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;toughness_mod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_val</span>

    <span class="c1"># Multi-color mana production → MANA_FIXING (dual lands, tri-lands, filter lands)</span>
    <span class="c1"># If card already has ADD_MANA but not MANA_FIXING, check for 2+ distinct color symbols</span>
    <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADD_MANA</span> <span class="ow">in</span> <span class="n">mechanics</span> <span class="ow">and</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_FIXING</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
        <span class="n">add_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;add\s+[^.]*&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">colors_in_add</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">add_text</span> <span class="ow">in</span> <span class="n">add_matches</span><span class="p">:</span>
            <span class="n">colors_in_add</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{([wubrg])\}&#39;</span><span class="p">,</span> <span class="n">add_text</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors_in_add</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MANA_FIXING</span><span class="p">)</span>

    <span class="c1"># Saga chapter parsing (use original text for roman numeral case matching)</span>
    <span class="k">if</span> <span class="s2">&quot;saga&quot;</span> <span class="ow">in</span> <span class="n">card_type_lower</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[IV]+\s*[—–\-]&#39;</span><span class="p">,</span> <span class="n">oracle_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">SAGA</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">SAGA</span><span class="p">)</span>
        <span class="n">chapters</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(I{1,3}|IV)\s*[—–\-]\s*(.+)$&#39;</span><span class="p">,</span> <span class="n">oracle_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="n">chapter_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">chapter_num</span><span class="p">,</span> <span class="n">chapter_text</span> <span class="ow">in</span> <span class="n">chapters</span><span class="p">:</span>
            <span class="n">chapter_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Parse chapter text for sub-effects (pre-compiled patterns)</span>
            <span class="n">chapter_text_lower</span> <span class="o">=</span> <span class="n">chapter_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">mechs</span> <span class="ow">in</span> <span class="n">PATTERNS</span><span class="p">:</span>
                <span class="n">sub_match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">chapter_text_lower</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sub_match</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">chapter_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;chapter_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chapter_count</span>

    <span class="c1"># Life gain parameter extraction</span>
    <span class="n">life_gain_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;gains?\s+(\d+)\s+life&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">life_gain_match</span><span class="p">:</span>
        <span class="n">life_gain_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;you gain\s+(\d+)\s+life&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">life_gain_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;life_gain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">life_gain_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Saddle parameter extraction</span>
    <span class="n">saddle_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;saddle\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">saddle_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;saddle_power&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">saddle_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Collect evidence parameter extraction</span>
    <span class="n">evidence_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;collect evidence\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">evidence_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;collect_evidence_mv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">evidence_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Impending parameter extraction</span>
    <span class="n">impending_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;impending\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">impending_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;impending_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">impending_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Equip cost parameter extraction</span>
    <span class="n">equip_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;equip\s*\{(\d+)\}&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">equip_match</span><span class="p">:</span>
        <span class="n">equip_complex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;equip\s*(\{[^}]+\})+&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">equip_complex</span><span class="p">:</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{([^}]+)\}&#39;</span><span class="p">,</span> <span class="n">equip_complex</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;equip_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">equip_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;equip_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">equip_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Becomes creature P/T parameter extraction</span>
    <span class="n">becomes_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;becomes?\s+a?\s*(\d+)/(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">becomes_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;becomes_power&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">becomes_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;becomes_toughness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">becomes_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Base power/toughness (auras like Darksteel Mutation, Unable to Scream)</span>
    <span class="n">base_pt_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;base power and toughness (\d+)/(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base_pt_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;set_power&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_pt_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;set_toughness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base_pt_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Crew power parameter extraction</span>
    <span class="n">crew_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;crew\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">crew_match</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;crew_power&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">crew_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Planeswalker loyalty ability parsing</span>
    <span class="k">if</span> <span class="s2">&quot;planeswalker&quot;</span> <span class="ow">in</span> <span class="n">card_type_lower</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_COUNTER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_COUNTER</span><span class="p">)</span>

        <span class="c1"># Match: +N:, −N: (en-dash U+2212), -N: (hyphen), 0:</span>
        <span class="n">loyalty_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^([+\-\u2212])(\d+)\s*:\s*(.+)$&#39;</span>
        <span class="n">abilities</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">loyalty_pattern</span><span class="p">,</span> <span class="n">oracle_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

        <span class="n">loyalty_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sign</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">ability_text</span> <span class="ow">in</span> <span class="n">abilities</span><span class="p">:</span>
            <span class="n">loyalty_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_PLUS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_PLUS</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_ZERO</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_ZERO</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># minus (hyphen or en-dash)</span>
                <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_MINUS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_MINUS</span><span class="p">)</span>

            <span class="c1"># Sub-parse ability text for effects (pre-compiled patterns)</span>
            <span class="n">ability_text_lower</span> <span class="o">=</span> <span class="n">ability_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">mechs</span> <span class="ow">in</span> <span class="n">PATTERNS</span><span class="p">:</span>
                <span class="n">sub_match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ability_text_lower</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sub_match</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

        <span class="c1"># Also handle bare &quot;0:&quot; (no sign prefix)</span>
        <span class="n">zero_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^0\s*:\s*(.+)$&#39;</span>
        <span class="n">zero_abilities</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">zero_pattern</span><span class="p">,</span> <span class="n">oracle_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ability_text</span> <span class="ow">in</span> <span class="n">zero_abilities</span><span class="p">:</span>
            <span class="n">loyalty_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_ZERO</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_ZERO</span><span class="p">)</span>
            <span class="n">ability_text_lower</span> <span class="o">=</span> <span class="n">ability_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">mechs</span> <span class="ow">in</span> <span class="n">PATTERNS</span><span class="p">:</span>
                <span class="n">sub_match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ability_text_lower</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sub_match</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

        <span class="c1"># Detect static abilities (lines with no +/-/0 prefix, not empty)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">oracle_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">stripped_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stripped_line</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[+\-\u2212]\d+\s*:&#39;</span><span class="p">,</span> <span class="n">stripped_line</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^0\s*:&#39;</span><span class="p">,</span> <span class="n">stripped_line</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_STATIC</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                    <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">LOYALTY_STATIC</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">loyalty_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;loyalty_ability_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loyalty_count</span>

    <span class="c1"># Emblem text sub-parsing</span>
    <span class="c1"># Pattern: &#39;you get an emblem with &quot;...&quot;&#39; or &#39;each opponent gets an emblem with &quot;...&quot;&#39;</span>
    <span class="n">emblem_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;(?:you|each opponent) gets? an emblem with &quot;([^&quot;]+)&quot;&#39;</span><span class="p">,</span>
        <span class="n">text</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">emblem_match</span> <span class="ow">in</span> <span class="n">emblem_matches</span><span class="p">:</span>
        <span class="n">emblem_text</span> <span class="o">=</span> <span class="n">emblem_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_EMBLEM</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
            <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">CREATE_EMBLEM</span><span class="p">)</span>
        <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">emblem_match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

        <span class="c1"># Detect opponent-targeted emblems</span>
        <span class="k">if</span> <span class="s2">&quot;each opponent&quot;</span> <span class="ow">in</span> <span class="n">emblem_match</span><span class="o">.</span><span class="n">group</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_OPPONENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_OPPONENT</span><span class="p">)</span>

        <span class="c1"># Classify emblem ability type</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(whenever|when|at the beginning)&#39;</span><span class="p">,</span> <span class="n">emblem_text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_TRIGGERED</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_TRIGGERED</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">emblem_text</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+.*:.*\w&#39;</span><span class="p">,</span> <span class="n">emblem_text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_ACTIVATED</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_ACTIVATED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_STATIC</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">EMBLEM_STATIC</span><span class="p">)</span>

        <span class="c1"># Sub-parse emblem text for effects (pre-compiled patterns)</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">mechs</span> <span class="ow">in</span> <span class="n">PATTERNS</span><span class="p">:</span>
            <span class="n">sub_match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">emblem_text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sub_match</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mechs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mechanics</span><span class="p">:</span>
                        <span class="n">mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">matched_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

    <span class="c1"># Calculate confidence based on how much text we parsed</span>
    <span class="c1"># Reminder text was already stripped at the top of this function</span>
    <span class="n">stripped_text</span> <span class="o">=</span> <span class="n">text</span>
    <span class="n">total_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripped_text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">parsed_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">matched_spans</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_words</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># No text to parse (e.g., vanilla creature)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">parsed_words</span> <span class="o">/</span> <span class="n">total_words</span><span class="p">))</span>

    <span class="c1"># Find unparsed text (for LLM fallback)</span>
    <span class="c1"># Use stripped text (no reminder text) as the baseline</span>
    <span class="n">unparsed</span> <span class="o">=</span> <span class="n">stripped_text</span>
    <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">matched_spans</span><span class="p">:</span>
        <span class="n">unparsed</span> <span class="o">=</span> <span class="n">unparsed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">unparsed</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unparsed</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>  <span class="c1"># Clean up whitespace</span>

    <span class="k">return</span> <span class="n">ParseResult</span><span class="p">(</span>
        <span class="n">mechanics</span><span class="o">=</span><span class="n">mechanics</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
        <span class="n">unparsed_text</span><span class="o">=</span><span class="n">unparsed</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unparsed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="parse_card">
<a class="viewcode-back" href="../../../api/mechanics.html#src.mechanics.card_parser.parse_card">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_card</span><span class="p">(</span><span class="n">card_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">CardEncoding</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a Scryfall card object into CardEncoding.</span>

<span class="sd">    Args:</span>
<span class="sd">        card_data: Scryfall API response for a single card</span>

<span class="sd">    Returns:</span>
<span class="sd">        CardEncoding object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle double-faced/split cards</span>
    <span class="k">if</span> <span class="s2">&quot;card_faces&quot;</span> <span class="ow">in</span> <span class="n">card_data</span> <span class="ow">and</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;card_faces&quot;</span><span class="p">):</span>
        <span class="c1"># Use the front face for primary encoding</span>
        <span class="n">front_face</span> <span class="o">=</span> <span class="n">card_data</span><span class="p">[</span><span class="s2">&quot;card_faces&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">front_face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">))</span>
        <span class="n">oracle_text</span> <span class="o">=</span> <span class="n">front_face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oracle_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">type_line</span> <span class="o">=</span> <span class="n">front_face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type_line&quot;</span><span class="p">,</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type_line&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">mana_cost</span> <span class="o">=</span> <span class="n">front_face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mana_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Also parse back face and combine mechanics</span>
        <span class="n">back_face</span> <span class="o">=</span> <span class="n">card_data</span><span class="p">[</span><span class="s2">&quot;card_faces&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card_data</span><span class="p">[</span><span class="s2">&quot;card_faces&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">back_oracle</span> <span class="o">=</span> <span class="n">back_face</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oracle_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">oracle_text</span> <span class="o">=</span> <span class="n">oracle_text</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">back_oracle</span> <span class="k">if</span> <span class="n">back_oracle</span> <span class="k">else</span> <span class="n">oracle_text</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Normal single-faced card</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
        <span class="n">oracle_text</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oracle_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">type_line</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type_line&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">mana_cost</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mana_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">cmc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cmc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Parse mana cost</span>
    <span class="n">mana_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="c1"># Single symbols: {W}, {U}, {B}, {R}, {G}, {C}, {1}, {2}, etc.</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{(\w)\}&#39;</span><span class="p">,</span> <span class="n">mana_cost</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">mana_dict</span><span class="p">:</span>
            <span class="n">mana_dict</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">symbol</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">mana_dict</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="c1"># Hybrid mana: {W/U}, {B/G}, etc. — count each color</span>
    <span class="k">for</span> <span class="n">hybrid</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{(\w)/(\w)\}&#39;</span><span class="p">,</span> <span class="n">mana_cost</span><span class="p">):</span>
        <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">hybrid</span>
        <span class="k">if</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">mana_dict</span> <span class="ow">and</span> <span class="n">c1</span> <span class="o">!=</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
            <span class="n">mana_dict</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">mana_dict</span> <span class="ow">and</span> <span class="n">c2</span> <span class="o">!=</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
            <span class="n">mana_dict</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># X costs: {X}</span>
    <span class="n">x_count</span> <span class="o">=</span> <span class="n">mana_cost</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{X}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">has_x_cost</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">x_count</span><span class="p">:</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;x_cost_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_count</span>
        <span class="n">has_x_cost</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Parse types (handle various dash characters and // for split cards)</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subtypes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Remove any back-face type line (after //)</span>
    <span class="k">if</span> <span class="s2">&quot;//&quot;</span> <span class="ow">in</span> <span class="n">type_line</span><span class="p">:</span>
        <span class="n">type_line</span> <span class="o">=</span> <span class="n">type_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># Handle em-dash, en-dash, and regular dash</span>
    <span class="k">for</span> <span class="n">dash</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;—&quot;</span><span class="p">,</span> <span class="s2">&quot;–&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">dash</span> <span class="ow">in</span> <span class="n">type_line</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">type_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dash</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">main_types</span><span class="p">,</span> <span class="n">sub_types</span> <span class="o">=</span> <span class="n">parts</span>
                <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">main_types</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="n">subtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sub_types</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">types</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">type_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

    <span class="c1"># Parse oracle text (pass name for self-reference stripping)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">parse_oracle_text</span><span class="p">(</span><span class="n">oracle_text</span><span class="p">,</span> <span class="n">type_line</span><span class="p">,</span> <span class="n">card_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Get power/toughness if creature</span>
    <span class="n">power</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">toughness</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;creature&quot;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="n">power_str</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;power&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">toughness_str</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;toughness&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">power</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">power_str</span><span class="p">)</span>
            <span class="n">toughness</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toughness_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Handle * or X</span>
            <span class="n">power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">power_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">toughness</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">toughness_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Detect card layout (adventure, modal_dfc, etc.)</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">card_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>
    <span class="n">layout_mechanics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">mechanics</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="s2">&quot;adventure&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">ADVENTURE_SPELL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layout_mechanics</span><span class="p">:</span>
            <span class="n">layout_mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">ADVENTURE_SPELL</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="s2">&quot;modal_dfc&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">MDFC</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layout_mechanics</span><span class="p">:</span>
            <span class="n">layout_mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">MDFC</span><span class="p">)</span>

    <span class="c1"># Fire X_COST mechanic from mana cost {X}</span>
    <span class="k">if</span> <span class="n">has_x_cost</span> <span class="ow">and</span> <span class="n">Mechanic</span><span class="o">.</span><span class="n">X_COST</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layout_mechanics</span><span class="p">:</span>
        <span class="n">layout_mechanics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mechanic</span><span class="o">.</span><span class="n">X_COST</span><span class="p">)</span>

    <span class="c1"># Merge mana-parsed parameters with oracle text parameters</span>
    <span class="n">merged_params</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">merged_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">CardEncoding</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">mana_cost</span><span class="o">=</span><span class="n">mana_dict</span><span class="p">,</span>
        <span class="n">cmc</span><span class="o">=</span><span class="n">cmc</span><span class="p">,</span>
        <span class="n">types</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
        <span class="n">subtypes</span><span class="o">=</span><span class="n">subtypes</span><span class="p">,</span>
        <span class="n">mechanics</span><span class="o">=</span><span class="n">layout_mechanics</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">merged_params</span><span class="p">,</span>
        <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span>
        <span class="n">toughness</span><span class="o">=</span><span class="n">toughness</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1"># TEST</span>
<span class="c1"># =============================================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Test with some example cards</span>
    <span class="n">test_cards</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Saw in Half&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mana_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{2}{B}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cmc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;type_line&quot;</span><span class="p">:</span> <span class="s2">&quot;Instant&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oracle_text&quot;</span><span class="p">:</span> <span class="s2">&quot;Destroy target creature. If that creature dies this way, its controller creates two tokens that are copies of that creature, except their power is half that creature&#39;s power and their toughness is half that creature&#39;s toughness. Round up each time.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Rhystic Study&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mana_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{2}{U}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cmc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;type_line&quot;</span><span class="p">:</span> <span class="s2">&quot;Enchantment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oracle_text&quot;</span><span class="p">:</span> <span class="s2">&quot;Whenever an opponent casts a spell, you may draw a card unless that player pays </span><span class="si">{1}</span><span class="s2">.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Deflecting Swat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mana_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{2}{R}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cmc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;type_line&quot;</span><span class="p">:</span> <span class="s2">&quot;Instant&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oracle_text&quot;</span><span class="p">:</span> <span class="s2">&quot;If you control a commander, you may cast this spell without paying its mana cost.</span><span class="se">\n</span><span class="s2">You may choose new targets for target spell or ability.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mulldrifter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mana_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{4}{U}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cmc&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;type_line&quot;</span><span class="p">:</span> <span class="s2">&quot;Creature — Elemental&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oracle_text&quot;</span><span class="p">:</span> <span class="s2">&quot;Flying</span><span class="se">\n</span><span class="s2">When Mulldrifter enters the battlefield, draw two cards.</span><span class="se">\n</span><span class="s2">Evoke </span><span class="si">{2}{U}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;toughness&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Starfield Vocalist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mana_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{3}{U}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cmc&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;type_line&quot;</span><span class="p">:</span> <span class="s2">&quot;Creature — Human Bard&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oracle_text&quot;</span><span class="p">:</span> <span class="s2">&quot;Warp </span><span class="si">{1}{U}</span><span class="se">\n</span><span class="s2">If a permanent entering the battlefield causes a triggered ability of a permanent you control to trigger, that ability triggers an additional time.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;power&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;toughness&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CARD PARSER TEST&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">card_data</span> <span class="ow">in</span> <span class="n">test_cards</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">parse_card</span><span class="p">(</span><span class="n">card_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">encoding</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Type: </span><span class="si">{</span><span class="n">encoding</span><span class="o">.</span><span class="n">types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cost: CMC </span><span class="si">{</span><span class="n">encoding</span><span class="o">.</span><span class="n">cmc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mechanics (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">mechanics</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">encoding</span><span class="o">.</span><span class="n">mechanics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Parameters: </span><span class="si">{</span><span class="n">encoding</span><span class="o">.</span><span class="n">parameters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parser handles common patterns. Complex text falls back to LLM.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, ForgeRL Contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>