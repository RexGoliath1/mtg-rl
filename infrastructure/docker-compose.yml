# MTG RL Docker Compose
# Run Forge daemon + Collection together
#
# Usage:
#   docker-compose up -d forge-daemon      # Start Forge daemon
#   docker-compose run collection          # Run collection
#   docker-compose logs -f forge-daemon    # View daemon logs

services:
  # Forge game engine daemon
  forge-daemon:
    build:
      context: .
      dockerfile: Dockerfile.daemon
    image: mtg-daemon:modern
    ports:
      - "17171:17171"
    healthcheck:
      test: ["CMD", "sh", "-c", "echo STATUS | nc -w 5 localhost 17171 | grep -q FORGE"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 4G

  # Python collection script
  collection:
    build:
      context: .
      dockerfile: Dockerfile.collection
    image: mtg-collection:latest
    depends_on:
      forge-daemon:
        condition: service_healthy
    volumes:
      - ./training_data:/app/training_data
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      python -u scripts/collect_ai_training_data.py
      --games ${COLLECTION_GAMES:-1000}
      --workers ${COLLECTION_WORKERS:-8}
      --host forge-daemon
      --output training_data/docker_run
      --save-interval 500

  # Quick test mode
  test-collection:
    build:
      context: .
      dockerfile: Dockerfile.collection
    depends_on:
      forge-daemon:
        condition: service_healthy
    volumes:
      - ./training_data:/app/training_data
    command: >
      python -u scripts/collect_ai_training_data.py
      --games 10
      --workers 4
      --host forge-daemon
      --output training_data/test
